<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNUCNM ê³„ì¸µì  ê³„ì‚°ì‹ ì¶”ì ê¸°</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group label {
            font-weight: bold;
            color: #667eea;
            min-width: 120px;
        }

        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .control-group button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .control-group button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .hierarchy-container {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .hierarchy-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info-item {
            text-align: center;
        }

        .info-item h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .info-item p {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        #hierarchy-graph {
            width: 100%;
            height: 800px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            overflow: hidden;
            position: relative;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .zoom-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .zoom-btn:hover {
            background: #5a6fd8;
        }

        .formula-details {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .formula-details h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .formula-tree {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }

        .formula-tree h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .formula-node {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .formula-node:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .formula-node.selected {
            border-color: #28a745;
            background: #f8fff9;
        }

        .formula-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .formula-expression {
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .formula-description {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ CNUCNM ê³„ì¸µì  ê³„ì‚°ì‹ ì¶”ì ê¸°</h1>
            <p>MP â†’ MPfeed â†’ DIGPB1 â†’ adjREPB1 â†’ REPB1 ê³„ì¸µì  ì˜ì¡´ì„± ì¶”ì  ë° ì‹œê°í™”</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>ì‹œì‘ ë³€ìˆ˜:</label>
                <select id="start-variable">
                    <option value="MP">MP (Metabolizable Protein)</option>
                    <option value="ME">ME (Metabolizable Energy)</option>
                    <option value="DMI">DMI (Dry Matter Intake)</option>
                    <option value="FHP">FHP (Fasting Heat Production)</option>
                    <option value="Growth_Energy">Growth Energy</option>
                    <option value="Lactation_Energy">Lactation Energy</option>
                </select>

                <label>ì¶”ì  ê¹Šì´:</label>
                <select id="trace-depth">
                    <option value="3">3ë‹¨ê³„</option>
                    <option value="5" selected>5ë‹¨ê³„</option>
                    <option value="7">7ë‹¨ê³„</option>
                    <option value="10">10ë‹¨ê³„</option>
                </select>

                <button onclick="traceFormula()">ğŸ” ì¶”ì  ì‹œì‘</button>
                <button onclick="resetView()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>

            <div class="control-group">
                <label>ë‚´ë³´ë‚´ê¸°:</label>
                <button class="export-btn" onclick="exportToExcel()">ğŸ“Š Excel ì¶”ì¶œ</button>
                <button class="export-btn" onclick="exportToCSV()">ğŸ“„ CSV ì¶”ì¶œ</button>
                <button class="export-btn" onclick="exportFormulaTree()">ğŸŒ³ ìˆ˜ì‹ íŠ¸ë¦¬</button>
            </div>
        </div>

        <div class="hierarchy-container">
            <div class="hierarchy-info">
                <div class="info-item">
                    <h4>ì´ ë³€ìˆ˜ ìˆ˜</h4>
                    <p id="total-variables">0</p>
                </div>
                <div class="info-item">
                    <h4>ê³„ì¸µ ë ˆë²¨</h4>
                    <p id="hierarchy-levels">0</p>
                </div>
                <div class="info-item">
                    <h4>ì„ íƒëœ ë³€ìˆ˜</h4>
                    <p id="selected-variable">ì—†ìŒ</p>
                </div>
                <div class="info-item">
                    <h4>ì¶”ì  ê²½ë¡œ</h4>
                    <p id="trace-path">ì—†ìŒ</p>
                </div>
            </div>

            <div id="hierarchy-graph">
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                    <button class="zoom-btn" onclick="resetZoom()">âŸ²</button>
                    <button class="zoom-btn" onclick="fitToScreen()">â¤¢</button>
                </div>
            </div>
        </div>

        <div class="formula-details">
            <h3>ğŸ“‹ ê³„ì¸µì  ìˆ˜ì‹ íŠ¸ë¦¬</h3>
            <div id="formula-tree-container">
                <div class="formula-tree">
                    <h4>MP (Metabolizable Protein) ê³„ì¸µ</h4>
                    <div class="formula-node" onclick="selectNode('MP')">
                        <div class="formula-name">MP</div>
                        <div class="formula-expression">MP = MPfeed + MPbact</div>
                        <div class="formula-description">ëŒ€ì‚¬ì„± ë‹¨ë°±ì§ˆ = ì‚¬ë£Œ ë‹¨ë°±ì§ˆ + ë¯¸ìƒë¬¼ ë‹¨ë°±ì§ˆ</div>
                    </div>
                    <div class="formula-node" onclick="selectNode('MPfeed')">
                        <div class="formula-name">MPfeed</div>
                        <div class="formula-expression">MPfeed = DIGPB1 + DIGPB2 + DIGPB3</div>
                        <div class="formula-description">ì‚¬ë£Œ ë‹¨ë°±ì§ˆ = ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ 1 + 2 + 3</div>
                    </div>
                    <div class="formula-node" onclick="selectNode('MPbact')">
                        <div class="formula-name">MPbact</div>
                        <div class="formula-expression">MPbact = MCP Ã— 0.64</div>
                        <div class="formula-description">ë¯¸ìƒë¬¼ ë‹¨ë°±ì§ˆ = ë¯¸ìƒë¬¼ ì¡°ë‹¨ë°±ì§ˆ Ã— íš¨ìœ¨ì„±</div>
                    </div>
                </div>

                <div class="formula-tree">
                    <h4>DIGPB (ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ) ê³„ì¸µ</h4>
                    <div class="formula-node" onclick="selectNode('DIGPB1')">
                        <div class="formula-name">DIGPB1</div>
                        <div class="formula-expression">DIGPB1 = ID_Protein_1 Ã— adjREPB1</div>
                        <div class="formula-description">ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ 1 = ì†Œì¥ ë‹¨ë°±ì§ˆ 1 Ã— ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 1</div>
                    </div>
                    <div class="formula-node" onclick="selectNode('DIGPB2')">
                        <div class="formula-name">DIGPB2</div>
                        <div class="formula-expression">DIGPB2 = ID_Protein_2 Ã— adjREPB2</div>
                        <div class="formula-description">ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ 2 = ì†Œì¥ ë‹¨ë°±ì§ˆ 2 Ã— ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 2</div>
                    </div>
                    <div class="formula-node" onclick="selectNode('DIGPB3')">
                        <div class="formula-name">DIGPB3</div>
                        <div class="formula-expression">DIGPB3 = ID_Protein_3 Ã— adjREPB3</div>
                        <div class="formula-description">ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ 3 = ì†Œì¥ ë‹¨ë°±ì§ˆ 3 Ã— ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 3</div>
                    </div>
                </div>

                <div class="formula-tree">
                    <h4>adjREPB (ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„±) ê³„ì¸µ</h4>
                    <div class="formula-node" onclick="selectNode('adjREPB1')">
                        <div class="formula-name">adjREPB1</div>
                        <div class="formula-expression">adjREPB1 = REPB1 + PeptidePass Ã— RDPB1 / RDPEP</div>
                        <div class="formula-description">ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 1 = ê¸°ë³¸ íš¨ìœ¨ì„± + í©íƒ€ì´ë“œ í†µê³¼ìœ¨ Ã— ë°˜ì¶”ìœ„ ë¶„í•´ ë‹¨ë°±ì§ˆ / ë°˜ì¶”ìœ„ ë¶„í•´ íš¨ìœ¨ì„±</div>
                    </div>
                    <div class="formula-node" onclick="selectNode('adjREPB2')">
                        <div class="formula-name">adjREPB2</div>
                        <div class="formula-expression">adjREPB2 = REPB2 + PeptidePass Ã— RDPB2 / RDPEP</div>
                        <div class="formula-description">ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 2</div>
                    </div>
                    <div class="formula-node" onclick="selectNode('adjREPB3')">
                        <div class="formula-name">adjREPB3</div>
                        <div class="formula-expression">adjREPB3 = REPB3 + PeptidePass Ã— RDPB3 / RDPEP</div>
                        <div class="formula-description">ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 3</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <h3>ê³„ì¸µ êµ¬ì¡° ìƒì„± ì¤‘...</h3>
        <p>ê³„ì‚°ì‹ ì˜ì¡´ì„±ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let hierarchyData = {
            nodes: [],
            links: []
        };
        let svg, g, simulation, node, link, label;
        let currentTracePath = [];

        // ìƒ‰ìƒ ë§µ
        const colorMap = {
            "MP": "#FF6B6B",
            "MPfeed": "#4ECDC4", 
            "MPbact": "#45B7D1",
            "DIGPB": "#96CEB4",
            "adjREPB": "#FFEAA7",
            "REPB": "#DDA0DD",
            "ID_Protein": "#98D8C8",
            "MCP": "#F7DC6F",
            "PeptidePass": "#BB8FCE",
            "RDPB": "#85C1E9",
            "RDPEP": "#F8C471"
        };

        // ê³„ì¸µì  ìˆ˜ì‹ ë°ì´í„° ìƒì„±
        function generateHierarchicalFormulaData() {
            const nodes = [];
            const links = [];
            let nodeId = 0;

            // MP ê³„ì¸µ êµ¬ì¡°
            const mpHierarchy = {
                "MP": {
                    formula: "MP = MPfeed + MPbact",
                    description: "ëŒ€ì‚¬ì„± ë‹¨ë°±ì§ˆ",
                    level: 0,
                    dependencies: ["MPfeed", "MPbact"]
                },
                "MPfeed": {
                    formula: "MPfeed = DIGPB1 + DIGPB2 + DIGPB3",
                    description: "ì‚¬ë£Œ ë‹¨ë°±ì§ˆ",
                    level: 1,
                    dependencies: ["DIGPB1", "DIGPB2", "DIGPB3"]
                },
                "MPbact": {
                    formula: "MPbact = MCP Ã— 0.64",
                    description: "ë¯¸ìƒë¬¼ ë‹¨ë°±ì§ˆ",
                    level: 1,
                    dependencies: ["MCP"]
                },
                "DIGPB1": {
                    formula: "DIGPB1 = ID_Protein_1 Ã— adjREPB1",
                    description: "ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ 1",
                    level: 2,
                    dependencies: ["ID_Protein_1", "adjREPB1"]
                },
                "DIGPB2": {
                    formula: "DIGPB2 = ID_Protein_2 Ã— adjREPB2",
                    description: "ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ 2",
                    level: 2,
                    dependencies: ["ID_Protein_2", "adjREPB2"]
                },
                "DIGPB3": {
                    formula: "DIGPB3 = ID_Protein_3 Ã— adjREPB3",
                    description: "ì†Œí™” ê°€ëŠ¥ ë‹¨ë°±ì§ˆ 3",
                    level: 2,
                    dependencies: ["ID_Protein_3", "adjREPB3"]
                },
                "adjREPB1": {
                    formula: "adjREPB1 = REPB1 + PeptidePass Ã— RDPB1 / RDPEP",
                    description: "ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 1",
                    level: 3,
                    dependencies: ["REPB1", "PeptidePass", "RDPB1", "RDPEP"]
                },
                "adjREPB2": {
                    formula: "adjREPB2 = REPB2 + PeptidePass Ã— RDPB2 / RDPEP",
                    description: "ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 2",
                    level: 3,
                    dependencies: ["REPB2", "PeptidePass", "RDPB2", "RDPEP"]
                },
                "adjREPB3": {
                    formula: "adjREPB3 = REPB3 + PeptidePass Ã— RDPB3 / RDPEP",
                    description: "ì¡°ì •ëœ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 3",
                    level: 3,
                    dependencies: ["REPB3", "PeptidePass", "RDPB3", "RDPEP"]
                },
                "REPB1": {
                    formula: "REPB1 = ê¸°ë³¸ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± ê³„ìˆ˜",
                    description: "ê¸°ë³¸ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 1",
                    level: 4,
                    dependencies: []
                },
                "REPB2": {
                    formula: "REPB2 = ê¸°ë³¸ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± ê³„ìˆ˜",
                    description: "ê¸°ë³¸ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 2",
                    level: 4,
                    dependencies: []
                },
                "REPB3": {
                    formula: "REPB3 = ê¸°ë³¸ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± ê³„ìˆ˜",
                    description: "ê¸°ë³¸ ë°˜ì¶”ìœ„ íš¨ìœ¨ì„± 3",
                    level: 4,
                    dependencies: []
                },
                "ID_Protein_1": {
                    formula: "ID_Protein_1 = ì†Œì¥ ë„ë‹¬ ë‹¨ë°±ì§ˆ 1",
                    description: "ì†Œì¥ ë„ë‹¬ ë‹¨ë°±ì§ˆ 1",
                    level: 4,
                    dependencies: []
                },
                "ID_Protein_2": {
                    formula: "ID_Protein_2 = ì†Œì¥ ë„ë‹¬ ë‹¨ë°±ì§ˆ 2",
                    description: "ì†Œì¥ ë„ë‹¬ ë‹¨ë°±ì§ˆ 2",
                    level: 4,
                    dependencies: []
                },
                "ID_Protein_3": {
                    formula: "ID_Protein_3 = ì†Œì¥ ë„ë‹¬ ë‹¨ë°±ì§ˆ 3",
                    description: "ì†Œì¥ ë„ë‹¬ ë‹¨ë°±ì§ˆ 3",
                    level: 4,
                    dependencies: []
                },
                "MCP": {
                    formula: "MCP = Available_energy Ã— MCP_efficiency",
                    description: "ë¯¸ìƒë¬¼ ì¡°ë‹¨ë°±ì§ˆ",
                    level: 2,
                    dependencies: ["Available_energy", "MCP_efficiency"]
                },
                "PeptidePass": {
                    formula: "PeptidePass = í©íƒ€ì´ë“œ í†µê³¼ìœ¨",
                    description: "í©íƒ€ì´ë“œ í†µê³¼ìœ¨",
                    level: 4,
                    dependencies: []
                },
                "RDPB1": {
                    formula: "RDPB1 = ë°˜ì¶”ìœ„ ë¶„í•´ ë‹¨ë°±ì§ˆ 1",
                    description: "ë°˜ì¶”ìœ„ ë¶„í•´ ë‹¨ë°±ì§ˆ 1",
                    level: 4,
                    dependencies: []
                },
                "RDPB2": {
                    formula: "RDPB2 = ë°˜ì¶”ìœ„ ë¶„í•´ ë‹¨ë°±ì§ˆ 2",
                    description: "ë°˜ì¶”ìœ„ ë¶„í•´ ë‹¨ë°±ì§ˆ 2",
                    level: 4,
                    dependencies: []
                },
                "RDPB3": {
                    formula: "RDPB3 = ë°˜ì¶”ìœ„ ë¶„í•´ ë‹¨ë°±ì§ˆ 3",
                    description: "ë°˜ì¶”ìœ„ ë¶„í•´ ë‹¨ë°±ì§ˆ 3",
                    level: 4,
                    dependencies: []
                },
                "RDPEP": {
                    formula: "RDPEP = ë°˜ì¶”ìœ„ ë¶„í•´ íš¨ìœ¨ì„±",
                    description: "ë°˜ì¶”ìœ„ ë¶„í•´ íš¨ìœ¨ì„±",
                    level: 4,
                    dependencies: []
                },
                "Available_energy": {
                    formula: "Available_energy = ë°œíš¨ ê°€ëŠ¥ ì—ë„ˆì§€",
                    description: "ë°œíš¨ ê°€ëŠ¥ ì—ë„ˆì§€",
                    level: 3,
                    dependencies: []
                },
                "MCP_efficiency": {
                    formula: "MCP_efficiency = ë¯¸ìƒë¬¼ íš¨ìœ¨ì„±",
                    description: "ë¯¸ìƒë¬¼ íš¨ìœ¨ì„±",
                    level: 3,
                    dependencies: []
                }
            };

            // ë…¸ë“œ ìƒì„±
            Object.entries(mpHierarchy).forEach(([name, data]) => {
                nodes.push({
                    id: nodeId++,
                    name: name,
                    formula: data.formula,
                    description: data.description,
                    level: data.level,
                    category: getCategoryFromName(name),
                    size: Math.max(8, 15 - data.level * 2)
                });
            });

            // ë§í¬ ìƒì„±
            Object.entries(mpHierarchy).forEach(([name, data]) => {
                const sourceNode = nodes.find(n => n.name === name);
                if (sourceNode && data.dependencies.length > 0) {
                    data.dependencies.forEach(dep => {
                        const targetNode = nodes.find(n => n.name === dep);
                        if (targetNode) {
                            links.push({
                                source: sourceNode.id,
                                target: targetNode.id,
                                strength: 1
                            });
                        }
                    });
                }
            });

            return { nodes, links };
        }

        // ì´ë¦„ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ê²°ì •
        function getCategoryFromName(name) {
            if (name.startsWith("MP")) return "MP";
            if (name.startsWith("DIGPB")) return "DIGPB";
            if (name.startsWith("adjREPB")) return "adjREPB";
            if (name.startsWith("REPB")) return "REPB";
            if (name.startsWith("ID_Protein")) return "ID_Protein";
            if (name.startsWith("RDPB")) return "RDPB";
            if (name === "MCP") return "MCP";
            if (name === "PeptidePass") return "PeptidePass";
            if (name === "RDPEP") return "RDPEP";
            if (name === "Available_energy") return "Available_energy";
            if (name === "MCP_efficiency") return "MCP_efficiency";
            return "OTHER";
        }

        // ê³„ì¸µ êµ¬ì¡° ì´ˆê¸°í™”
        function initializeHierarchy() {
            const width = document.getElementById('hierarchy-graph').clientWidth;
            const height = document.getElementById('hierarchy-graph').clientHeight;

            svg = d3.select("#hierarchy-graph")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            g = svg.append("g");

            // ì¤Œ ê¸°ëŠ¥
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);

            // ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •
            simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id).distance(80))
                .force("charge", d3.forceManyBody().strength(-500))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => d.size + 10))
                .force("x", d3.forceX().x(d => d.level * 150 + 100).strength(0.3));

            // ë°ì´í„° ë¡œë“œ
            hierarchyData = generateHierarchicalFormulaData();
            
            // ë§í¬ ê·¸ë¦¬ê¸°
            link = g.append("g")
                .selectAll("line")
                .data(hierarchyData.links)
                .enter().append("line")
                .attr("class", "link")
                .style("stroke", "#999")
                .style("stroke-opacity", 0.6)
                .style("stroke-width", d => d.strength * 2);

            // ë…¸ë“œ ê·¸ë¦¬ê¸°
            node = g.append("g")
                .selectAll("circle")
                .data(hierarchyData.nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", d => d.size)
                .style("fill", d => colorMap[d.category] || "#ccc")
                .style("stroke", "#fff")
                .style("stroke-width", 2)
                .call(drag(simulation));

            // ë…¸ë“œ ë¼ë²¨
            label = g.append("g")
                .selectAll("text")
                .data(hierarchyData.nodes)
                .enter().append("text")
                .text(d => d.name)
                .attr("text-anchor", "middle")
                .attr("dy", ".35em")
                .style("font-size", "10px")
                .style("fill", "#333")
                .style("pointer-events", "none");

            // íˆ´íŒ
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // ë…¸ë“œ ì´ë²¤íŠ¸
            node.on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                
                let tooltipContent = `<strong>${d.name}</strong><br/>`;
                tooltipContent += `ìˆ˜ì‹: ${d.formula}<br/>`;
                tooltipContent += `ì„¤ëª…: ${d.description}<br/>`;
                tooltipContent += `ë ˆë²¨: ${d.level}<br/>`;
                tooltipContent += `ì¹´í…Œê³ ë¦¬: ${d.category}`;

                tooltip.html(tooltipContent)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                
                // ì—°ê²°ëœ ë§í¬ í•˜ì´ë¼ì´íŠ¸
                link.style("stroke-opacity", l => 
                    l.source.id === d.id || l.target.id === d.id ? 1 : 0.1
                );
            })
            .on("mouseout", function() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                link.style("stroke-opacity", 0.6);
            })
            .on("click", function(event, d) {
                selectNode(d.name);
            });

            // ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸
            simulation.nodes(hierarchyData.nodes);
            simulation.force("link").links(hierarchyData.links);
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

            updateStats();
        }

        // ë“œë˜ê·¸ ê¸°ëŠ¥
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        // ì¤Œ ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤
        function zoomIn() {
            svg.transition().duration(300).call(
                d3.zoom().scaleBy, 1.5
            );
        }

        function zoomOut() {
            svg.transition().duration(300).call(
                d3.zoom().scaleBy, 1 / 1.5
            );
        }

        function resetZoom() {
            svg.transition().duration(300).call(
                d3.zoom().transform, d3.zoomIdentity
            );
        }

        function fitToScreen() {
            const bounds = g.node().getBBox();
            const fullWidth = document.getElementById('hierarchy-graph').clientWidth;
            const fullHeight = document.getElementById('hierarchy-graph').clientHeight;
            const width = bounds.width;
            const height = bounds.height;
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;
            
            if (width == 0 || height == 0) return;
            
            const scale = 0.9 / Math.max(width / fullWidth, height / fullHeight);
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
            
            svg.transition().duration(300).call(
                d3.zoom().transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('total-variables').textContent = hierarchyData.nodes.length;
            document.getElementById('hierarchy-levels').textContent = Math.max(...hierarchyData.nodes.map(n => n.level)) + 1;
        }

        // ìˆ˜ì‹ ì¶”ì 
        function traceFormula() {
            const startVar = document.getElementById('start-variable').value;
            const depth = parseInt(document.getElementById('trace-depth').value);
            
            document.getElementById('loading').style.display = 'block';
            
            setTimeout(() => {
                currentTracePath = traceFormulaPath(startVar, depth);
                highlightTracePath(currentTracePath);
                document.getElementById('selected-variable').textContent = startVar;
                document.getElementById('trace-path').textContent = currentTracePath.join(' â†’ ');
                document.getElementById('loading').style.display = 'none';
            }, 1000);
        }

        // ìˆ˜ì‹ ê²½ë¡œ ì¶”ì 
        function traceFormulaPath(startVar, depth) {
            const path = [startVar];
            const visited = new Set([startVar]);
            
            function traceRecursive(varName, currentDepth) {
                if (currentDepth >= depth) return;
                
                const node = hierarchyData.nodes.find(n => n.name === varName);
                if (!node) return;
                
                const dependencies = hierarchyData.links
                    .filter(l => l.source.name === varName)
                    .map(l => l.target.name);
                
                for (const dep of dependencies) {
                    if (!visited.has(dep)) {
                        visited.add(dep);
                        path.push(dep);
                        traceRecursive(dep, currentDepth + 1);
                    }
                }
            }
            
            traceRecursive(startVar, 0);
            return path;
        }

        // ì¶”ì  ê²½ë¡œ í•˜ì´ë¼ì´íŠ¸
        function highlightTracePath(path) {
            node.style("opacity", d => path.includes(d.name) ? 1 : 0.3);
            link.style("stroke-opacity", d => {
                const sourceName = d.source.name || hierarchyData.nodes.find(n => n.id === d.source).name;
                const targetName = d.target.name || hierarchyData.nodes.find(n => n.id === d.target).name;
                return path.includes(sourceName) && path.includes(targetName) ? 0.8 : 0.1;
            });
        }

        // ë…¸ë“œ ì„ íƒ
        function selectNode(nodeName) {
            document.getElementById('selected-variable').textContent = nodeName;
            
            // ìˆ˜ì‹ íŠ¸ë¦¬ì—ì„œ ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.formula-node').forEach(node => {
                node.classList.remove('selected');
            });
            
            const selectedNode = document.querySelector(`[onclick="selectNode('${nodeName}')"]`);
            if (selectedNode) {
                selectedNode.classList.add('selected');
            }
        }

        // ë·° ì´ˆê¸°í™”
        function resetView() {
            simulation.alpha(1).restart();
            node.style("opacity", 1);
            link.style("stroke-opacity", 0.6);
            document.getElementById('selected-variable').textContent = 'ì—†ìŒ';
            document.getElementById('trace-path').textContent = 'ì—†ìŒ';
            currentTracePath = [];
            
            document.querySelectorAll('.formula-node').forEach(node => {
                node.classList.remove('selected');
            });
        }

        // Excel ì¶”ì¶œ ê¸°ëŠ¥
        function exportToExcel() {
            const workbook = XLSX.utils.book_new();
            
            // ê³„ì¸µ êµ¬ì¡° ì‹œíŠ¸
            const hierarchySheet = hierarchyData.nodes.map(node => ({
                'ë³€ìˆ˜ëª…': node.name,
                'ìˆ˜ì‹': node.formula,
                'ì„¤ëª…': node.description,
                'ë ˆë²¨': node.level,
                'ì¹´í…Œê³ ë¦¬': node.category,
                'ë…¸ë“œí¬ê¸°': node.size
            }));
            
            const hierarchyWS = XLSX.utils.json_to_sheet(hierarchySheet);
            XLSX.utils.book_append_sheet(workbook, hierarchyWS, "ê³„ì¸µêµ¬ì¡°");
            
            // ì—°ê²° ê´€ê³„ ì‹œíŠ¸
            const linkSheet = hierarchyData.links.map(link => {
                const sourceNode = hierarchyData.nodes.find(n => n.id === link.source);
                const targetNode = hierarchyData.nodes.find(n => n.id === link.target);
                return {
                    'ì¶œë°œë³€ìˆ˜': sourceNode ? sourceNode.name : link.source,
                    'ë„ì°©ë³€ìˆ˜': targetNode ? targetNode.name : link.target,
                    'ì¶œë°œë ˆë²¨': sourceNode ? sourceNode.level : '',
                    'ë„ì°©ë ˆë²¨': targetNode ? targetNode.level : '',
                    'ì—°ê²°ê°•ë„': link.strength
                };
            });
            
            const linkWS = XLSX.utils.json_to_sheet(linkSheet);
            XLSX.utils.book_append_sheet(workbook, linkWS, "ì—°ê²°ê´€ê³„");
            
            // ì¶”ì  ê²½ë¡œ ì‹œíŠ¸
            const traceSheet = currentTracePath.map((varName, index) => ({
                'ìˆœì„œ': index + 1,
                'ë³€ìˆ˜ëª…': varName,
                'ë ˆë²¨': hierarchyData.nodes.find(n => n.name === varName)?.level || 0
            }));
            
            const traceWS = XLSX.utils.json_to_sheet(traceSheet);
            XLSX.utils.book_append_sheet(workbook, traceWS, "ì¶”ì ê²½ë¡œ");
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(workbook, 'CNUCNM_Hierarchical_Formula_Trace.xlsx');
        }

        // CSV ì¶”ì¶œ ê¸°ëŠ¥
        function exportToCSV() {
            // ê³„ì¸µ êµ¬ì¡° CSV
            const hierarchyCSV = hierarchyData.nodes.map(node => 
                `${node.name},${node.formula},${node.description},${node.level},${node.category},${node.size}`
            ).join('\n');
            
            const hierarchyBlob = new Blob(['ë³€ìˆ˜ëª…,ìˆ˜ì‹,ì„¤ëª…,ë ˆë²¨,ì¹´í…Œê³ ë¦¬,ë…¸ë“œí¬ê¸°\n' + hierarchyCSV], { type: 'text/csv' });
            const hierarchyUrl = URL.createObjectURL(hierarchyBlob);
            const hierarchyLink = document.createElement('a');
            hierarchyLink.href = hierarchyUrl;
            hierarchyLink.download = 'CNUCNM_Hierarchy.csv';
            hierarchyLink.click();
            
            // ì¶”ì  ê²½ë¡œ CSV
            const traceCSV = currentTracePath.map((varName, index) => 
                `${index + 1},${varName},${hierarchyData.nodes.find(n => n.name === varName)?.level || 0}`
            ).join('\n');
            
            const traceBlob = new Blob(['ìˆœì„œ,ë³€ìˆ˜ëª…,ë ˆë²¨\n' + traceCSV], { type: 'text/csv' });
            const traceUrl = URL.createObjectURL(traceBlob);
            const traceLink = document.createElement('a');
            traceLink.href = traceUrl;
            traceLink.download = 'CNUCNM_Trace_Path.csv';
            traceLink.click();
        }

        // ìˆ˜ì‹ íŠ¸ë¦¬ ë‚´ë³´ë‚´ê¸°
        function exportFormulaTree() {
            const treeData = hierarchyData.nodes
                .sort((a, b) => a.level - b.level)
                .map(node => `${'  '.repeat(node.level)}${node.name}: ${node.formula}`)
                .join('\n');
            
            const blob = new Blob([treeData], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'CNUCNM_Formula_Tree.txt';
            link.click();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            document.getElementById('loading').style.display = 'block';
            
            setTimeout(() => {
                initializeHierarchy();
                document.getElementById('loading').style.display = 'none';
            }, 1000);
        });
    </script>
</body>
</html>
