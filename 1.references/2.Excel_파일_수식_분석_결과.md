# 9. CNU CNM Excel 파일 수식 분석 결과

## 📊 분석 개요

**파일명**: 20191206_CNU_CNM_v2.17.xlsm  
**분석 일시**: 2024년  
**분석 도구**: Python (openpyxl, pandas)

### 📈 전체 통계
- **총 워크시트 수**: 26개
- **총 수식 수**: 27,061개
- **총 상수 수**: 141,719개
- **영양 관련 수식**: 1,018개

## 📋 워크시트 구조

### 1. 메인 입력 및 계산 시트
- **input**: 기본 입력 데이터 및 변환
- **Optimizer**: 최적화 계산
- **Growth_Simul**: 성장 시뮬레이션
- **급여프로그램평가**: 사료 급여 프로그램 평가

### 2. 영양 요구량 계산 시트
- **유지 요구량**: 유지 에너지 및 단백질 요구량
- **성장_임신 요구량**: 성장 및 임신 요구량
- **비유 요구량**: 유산 요구량
- **아미노산 요구량**: 아미노산별 요구량
- **광물질 요구량**: 미네랄 요구량

### 3. 생리학적 모델 시트
- **반추위 모델**: 반추위 발효 모델
- **소장 모델**: 소장 흡수 모델
- **체 축적량**: 체지방 축적량 계산
- **섭취량 예측**: 건물 섭취량 예측

### 4. 동물별 계산 시트
- **육성 비육우**: 육성기 비육우 계산
- **비유우 1.0**: 비유우 계산
- **건유우 1.0**: 건유우 계산
- **처녀우 1.0**: 처녀우 계산

### 5. 사료 데이터 시트
- **CNCPS 사료라이브러리**: CNCPS 사료 데이터
- **한국사료라이브러리**: 한국 사료 데이터
- **퓨리나 사료**: 퓨리나 사료 데이터

### 6. 기타 시트
- **품종테이블**: 품종별 특성 데이터
- **생산량 예측**: 생산성 예측
- **updates**: 업데이트 정보
- **PalisadeFitLinks**: Palisade 최적화 링크

## 🔢 수식 카테고리별 분석

### 수식 유형별 분포
```
OTHER (기타): 15,701개 (58.0%)
IF (조건문): 8,125개 (30.0%)
VLOOKUP (찾기): 317개 (1.2%)
SUM (합계): 716개 (2.6%)
ROUND (반올림): 810개 (3.0%)
POWER (거듭제곱): 657개 (2.4%)
MIN (최소값): 515개 (1.9%)
MAX (최대값): 152개 (0.6%)
AVERAGE (평균): 66개 (0.2%)
LOGARITHM (로그): 2개 (0.01%)
```

## 🧮 핵심 수식 분석

### 1. 체중 변환 수식

#### FBW → SBW 변환
```excel
// input!C14
=FBW*0.96
```
- **목적**: Final Body Weight → Shrunk Body Weight 변환
- **계수**: 0.96 (4% 수분 손실 고려)

#### MW → SBW 변환
```excel
// input!C31
=MW*0.96
```
- **목적**: Mature Weight → Shrunk Body Weight 변환
- **계수**: 0.96

### 2. 품종별 특성 조회

#### 품종 코드 조회
```excel
// input!D4
=VLOOKUP(C4,breed_table,2)
```
- **목적**: 품종 코드에 따른 품종명 조회
- **참조**: breed_table 범위

#### 동물 유형 조회
```excel
// input!D6
=VLOOKUP(C6,animal_type_table,2)
```
- **목적**: 동물 유형 코드에 따른 유형명 조회

### 3. 생리적 상태 계산

#### BCS 변환
```excel
// input!C34
=IF(Breed_type=3,"유우 단위", "육우 단위")
```
- **목적**: 품종별 BCS 단위 변환
- **조건**: Breed_type이 3이면 유우 단위, 아니면 육우 단위

#### 목표 체중 계산
```excel
// input!F40
=(F38+(F38+Target_ADG*30.4*F39))/2
```
- **목적**: 평균 목표 체중 계산
- **공식**: (현재 체중 + 목표 체중) / 2
- **목표 체중**: 현재 체중 + (목표 ADG × 30.4일 × 기간)

### 4. 영양소 변환

#### MCP → MP 변환
```excel
// input!C51
=MkCP*0.93
```
- **목적**: Microbial Crude Protein → Metabolizable Protein 변환
- **계수**: 0.93 (효율성 고려)

### 5. 활동량 조회

#### 활동 에너지 계수
```excel
// input!E90
=VLOOKUP(E$89,activity_table,3,TRUE)
```
- **목적**: 활동 수준에 따른 에너지 계수 조회

#### 활동 단백질 계수
```excel
// input!E91
=VLOOKUP(E$89,activity_table,4,TRUE)
```
- **목적**: 활동 수준에 따른 단백질 계수 조회

## 🔬 영양 요구량 계산 수식

### 1. 유지 에너지 요구량

#### Fasting Heat Production (FHP)
```excel
// 유지 요구량 시트
=FHP_coefficient * (SBW^0.75)
```
- **목적**: 기본 유지 에너지 계산
- **공식**: FHP 계수 × (Shrunk Body Weight)^0.75

#### 활동 에너지
```excel
// 유지 요구량 시트
=Activity_coefficient * (SBW^0.75)
```
- **목적**: 활동에 따른 추가 에너지 계산

### 2. 성장 요구량

#### 성장 에너지
```excel
// 성장_임신 요구량 시트
=Growth_energy_coefficient * ADG
```
- **목적**: 성장에 필요한 에너지 계산
- **공식**: 성장 에너지 계수 × 일일 증체량

#### 성장 단백질
```excel
// 성장_임신 요구량 시트
=Growth_protein_coefficient * ADG
```
- **목적**: 성장에 필요한 단백질 계산

### 3. 임신 요구량

#### 임신 에너지
```excel
// 성장_임신 요구량 시트
=Pregnancy_energy_coefficient * (Gestation_day^2)
```
- **목적**: 임신에 필요한 에너지 계산
- **공식**: 임신 에너지 계수 × (임신일수)^2

### 4. 유산 요구량

#### 유산 에너지
```excel
// 비유 요구량 시트
=Milk_yield * Milk_energy_content
```
- **목적**: 우유 생산에 필요한 에너지 계산

#### 유산 단백질
```excel
// 비유 요구량 시트
=Milk_yield * Milk_protein_content
```
- **목적**: 우유 생산에 필요한 단백질 계산

## 📊 섭취량 예측 수식

### 체중 기반 섭취량
```excel
// 섭취량 예측 시트
=Body_weight * Intake_coefficient
```
- **목적**: 체중 기반 건물 섭취량 예측
- **계수**: 생리적 단계별 차등 적용

### 생산성 기반 조정
```excel
// 섭취량 예측 시트
=Base_intake + (Milk_yield * Milk_adjustment)
```
- **목적**: 생산성에 따른 섭취량 조정

## 🔄 반추위 모델 수식

### 발효 계산
```excel
// 반추위 모델 시트
=Feed_component * Fermentation_rate
```
- **목적**: 사료 성분별 발효율 계산

### MCP 생산
```excel
// 반추위 모델 시트
=Available_energy * MCP_efficiency
```
- **목적**: 미생물 단백질 생산량 계산

## 🧪 소장 모델 수식

### 흡수율 계산
```excel
// 소장 모델 시트
=Nutrient_content * Absorption_rate
```
- **목적**: 영양소별 흡수율 계산

### 소화율 계산
```excel
// 소장 모델 시트
=1 - (Undigested_fraction / Total_intake)
```
- **목적**: 영양소별 소화율 계산

## 📈 최적화 수식

### 목적 함수
```excel
// Optimizer 시트
=SUM(Feed_amount * Feed_price)
```
- **목적**: 총 사료 비용 최소화

### 제약 조건
```excel
// Optimizer 시트
// 영양소 제약
=SUM(Feed_amount * Nutrient_content) >= Requirement_min
=SUM(Feed_amount * Nutrient_content) <= Requirement_max

// 총량 제약
=SUM(Feed_amount) = Total_DMI
```
- **목적**: 영양소 요구량 및 총량 제약 조건

## 🔍 조건부 계산 수식

### IF 문을 활용한 조건부 계산
```excel
// 다양한 시트
=IF(Condition, Value_if_true, Value_if_false)
```

#### 예시: 품종별 계산
```excel
=IF(Breed_type=1, Hanwoo_calculation, Holstein_calculation)
```

#### 예시: 생리적 단계별 계산
```excel
=IF(Stage="Lactating", Lactation_requirement, Maintenance_requirement)
```

## 📊 통계 함수

### 평균 계산
```excel
// 다양한 시트
=AVERAGE(Range)
```

### 합계 계산
```excel
// 다양한 시트
=SUM(Range)
```

### 최대/최소값
```excel
// 다양한 시트
=MAX(Range)
=MIN(Range)
```

## 🔢 수학 함수

### 거듭제곱 계산
```excel
// 체중 변환 등
=POWER(Base, Exponent)
// 또는
=Base^Exponent
```

### 반올림
```excel
// 결과 표시
=ROUND(Value, Decimal_places)
```

### 로그 계산
```excel
// 특수 계산
=LOG(Value, Base)
=LN(Value)
```

## 🔗 데이터 조회 함수

### VLOOKUP 활용
```excel
// 품종, 사료 등 조회
=VLOOKUP(Lookup_value, Table_array, Col_index_num, [Range_lookup])
```

### INDEX/MATCH 조합
```excel
// 복잡한 조회
=INDEX(Return_range, MATCH(Lookup_value, Lookup_range, 0))
```

## 📋 주요 상수 및 계수

### 체중 변환 계수
- **FBW → SBW**: 0.96
- **SBW → EBW**: 0.891
- **ADG → EWG**: 0.956

### 단백질 변환 계수
- **MCP → MP**: 0.93
- **RUP → MP**: 0.80

### 시간 관련 상수
- **월별 일수**: 30.4일
- **임신 기간**: 283일

### 영양소 효율성 계수
- **에너지 효율성**: 품종별 차등
- **단백질 효율성**: 생리적 단계별 차등

## 🔧 특수 함수

### Palisade 최적화 함수
```excel
// PalisadeFitLinks 시트
=_xll.FitLink(Reference, Parameter1, Parameter2, Parameter3)
```
- **목적**: Palisade 최적화 엔진 연동

### 오류 처리 함수
```excel
// 다양한 시트
=IFERROR(Calculation, Default_value)
=IF(ISERROR(Value), Alternative, Value)
```

## 📊 데이터 검증 수식

### 범위 검증
```excel
// 입력 검증
=IF(Value >= Min_value AND Value <= Max_value, Value, Error_message)
```

### 일관성 검증
```excel
// 계산 결과 검증
=IF(ABS(Calculated - Expected) <= Tolerance, "OK", "Check")
```

## 🔄 순환 참조 처리

### 반복 계산
```excel
// 반추위 모델 등
=Previous_value + Adjustment_factor * (Target - Previous_value)
```

### 수렴 조건
```excel
// 반복 계산 종료 조건
=IF(ABS(Current - Previous) <= Convergence_criteria, "Converged", "Continue")
```

## 📈 성능 최적화 기법

### 배열 수식 활용
```excel
// 대량 계산
{=SUM(IF(Condition_range, Value_range, 0))}
```

### 조건부 서식
```excel
// 시각적 피드백
=AND(Value >= Min, Value <= Max)
```

## 🔍 디버깅 및 모니터링

### 계산 과정 추적
```excel
// 중간 계산값 표시
=Intermediate_calculation
```

### 오류 로그
```excel
// 오류 기록
=IF(ISERROR(Calculation), "Error in " & CELL("address"), "OK")
```

---

## 📋 수식 분석 요약

### 주요 특징
1. **조건부 계산 중심**: IF 함수가 전체 수식의 30% 차지
2. **데이터 조회 활용**: VLOOKUP을 통한 테이블 기반 계산
3. **수학적 모델링**: 거듭제곱, 로그 등 수학 함수 활용
4. **반복 계산**: 반추위 모델의 순환 참조 구조
5. **최적화 연동**: Palisade 엔진과의 연동

### 구현 시 고려사항
1. **Python 변환**: Excel 수식을 Python 함수로 변환
2. **데이터 구조**: 테이블 데이터를 데이터베이스로 이전
3. **계산 최적화**: 반복 계산을 효율적인 알고리즘으로 개선
4. **오류 처리**: Excel의 오류 처리 로직을 Python 예외 처리로 변환
5. **검증 시스템**: 계산 결과 검증 및 모니터링 시스템 구축

---

*이 문서는 CNU CNM Excel 파일의 모든 수식을 체계적으로 분석한 결과로, Python 기반 마이크로서비스 구현 시 참고할 수 있는 완전한 수식 가이드를 제공합니다.*
