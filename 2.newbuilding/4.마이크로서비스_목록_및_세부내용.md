# 4. CNUCNM 마이크로서비스 목록 및 세부내용

## 📋 마이크로서비스 목록

### 1. 사용자 관리 서비스 (User Management Service)
### 2. 동물 정보 관리 서비스 (Animal Management Service)
### 3. 사료 라이브러리 서비스 (Feed Library Service)
### 4. 영양 요구량 계산 서비스 (Nutrition Requirements Service)
### 5. 사료 배합 최적화 서비스 (Feed Formulation Service)
### 6. 영양 분석 서비스 (Nutrition Analysis Service)
### 7. 섭취량 예측 서비스 (Intake Prediction Service)
### 8. 보고서 생성 서비스 (Report Generation Service)
### 9. 알림 서비스 (Notification Service)
### 10. 데이터 분석 서비스 (Analytics Service)

## 🔧 각 마이크로서비스 상세 설계

### 1. 사용자 관리 서비스 (User Management Service)

#### 서비스 개요
- **목적**: 사용자 인증, 권한 관리, 프로필 관리
- **기술 스택**: FastAPI, PostgreSQL, Redis, JWT
- **포트**: 8001

#### 데이터 모델
```python
# User Model
class User(BaseModel):
    id: UUID
    email: str
    username: str
    password_hash: str
    role: UserRole
    is_active: bool
    created_at: datetime
    updated_at: datetime

# Farm Model
class Farm(BaseModel):
    id: UUID
    user_id: UUID
    name: str
    address: str
    farm_type: FarmType
    animal_count: int
    created_at: datetime

# Subscription Model
class Subscription(BaseModel):
    id: UUID
    user_id: UUID
    plan_type: PlanType
    start_date: datetime
    end_date: datetime
    is_active: bool
```

#### API 엔드포인트
```python
# 인증
POST /auth/register
POST /auth/login
POST /auth/refresh
POST /auth/logout
POST /auth/forgot-password
POST /auth/reset-password

# 사용자 관리
GET /users/me
PUT /users/me
DELETE /users/me
GET /users/{user_id}
PUT /users/{user_id}

# 농장 관리
GET /farms
POST /farms
GET /farms/{farm_id}
PUT /farms/{farm_id}
DELETE /farms/{farm_id}

# 구독 관리
GET /subscriptions
POST /subscriptions
GET /subscriptions/{subscription_id}
PUT /subscriptions/{subscription_id}
```

#### 주요 기능
- JWT 기반 인증
- 비밀번호 암호화 (bcrypt)
- 이메일 인증
- 소셜 로그인 (Google, Kakao)
- 역할 기반 권한 관리
- 구독 관리

---

### 2. 동물 정보 관리 서비스 (Animal Management Service)

#### 서비스 개요
- **목적**: 동물 정보 등록, 관리, 추적
- **기술 스택**: FastAPI, PostgreSQL, MinIO
- **포트**: 8002

#### 데이터 모델
```python
# Animal Model
class Animal(BaseModel):
    id: UUID
    farm_id: UUID
    animal_id: str  # 농장 내 고유 ID
    breed: BreedType
    gender: GenderType
    birth_date: date
    weight: float
    bcs: float  # Body Condition Score
    stage: PhysiologicalStage
    created_at: datetime

# Animal Health Record
class HealthRecord(BaseModel):
    id: UUID
    animal_id: UUID
    record_type: HealthRecordType
    description: str
    date: date
    veterinarian: str
    treatment: str
    created_at: datetime

# Production Record
class ProductionRecord(BaseModel):
    id: UUID
    animal_id: UUID
    record_date: date
    milk_yield: float
    milk_fat: float
    milk_protein: float
    weight: float
    created_at: datetime
```

#### API 엔드포인트
```python
# 동물 관리
GET /animals
POST /animals
GET /animals/{animal_id}
PUT /animals/{animal_id}
DELETE /animals/{animal_id}
GET /animals/{animal_id}/history

# 건강 기록
GET /animals/{animal_id}/health-records
POST /animals/{animal_id}/health-records
PUT /health-records/{record_id}
DELETE /health-records/{record_id}

# 생산 기록
GET /animals/{animal_id}/production-records
POST /animals/{animal_id}/production-records
PUT /production-records/{record_id}
DELETE /production-records/{record_id}

# 그룹 관리
GET /animal-groups
POST /animal-groups
GET /animal-groups/{group_id}
PUT /animal-groups/{group_id}
DELETE /animal-groups/{group_id}
```

#### 주요 기능
- QR코드/RFID 연동
- 체중 변화 추적
- 생산성 모니터링
- 건강 기록 관리
- 그룹별 관리
- 사진 업로드

---

### 3. 사료 라이브러리 서비스 (Feed Library Service)

#### 서비스 개요
- **목적**: 사료 정보 관리, 검색, 비교
- **기술 스택**: FastAPI, PostgreSQL, Elasticsearch
- **포트**: 8003

#### 데이터 모델
```python
# Feed Model
class Feed(BaseModel):
    id: UUID
    name: str
    name_korean: str
    feed_class: FeedClass
    category: FeedCategory
    description: str
    created_at: datetime

# Feed Nutrient Composition
class FeedNutrient(BaseModel):
    id: UUID
    feed_id: UUID
    dry_matter: float
    crude_protein: float
    crude_fat: float
    crude_fiber: float
    ndf: float
    adf: float
    tdn: float
    me: float
    calcium: float
    phosphorus: float
    created_at: datetime

# Feed Price
class FeedPrice(BaseModel):
    id: UUID
    feed_id: UUID
    price_per_kg: float
    currency: str
    effective_date: date
    supplier: str
    created_at: datetime
```

#### API 엔드포인트
```python
# 사료 관리
GET /feeds
POST /feeds
GET /feeds/{feed_id}
PUT /feeds/{feed_id}
DELETE /feeds/{feed_id}

# 사료 검색
GET /feeds/search
GET /feeds/search/advanced
GET /feeds/compare

# 영양 성분
GET /feeds/{feed_id}/nutrients
POST /feeds/{feed_id}/nutrients
PUT /nutrients/{nutrient_id}

# 가격 정보
GET /feeds/{feed_id}/prices
POST /feeds/{feed_id}/prices
GET /feeds/prices/current

# 사용자 정의 사료
GET /custom-feeds
POST /custom-feeds
PUT /custom-feeds/{feed_id}
DELETE /custom-feeds/{feed_id}
```

#### 주요 기능
- 고급 검색 (Elasticsearch)
- 영양성분 비교
- 가격 추적
- 사용자 정의 사료
- 품질 인증 정보
- 공급업체 정보

---

### 4. 영양 요구량 계산 서비스 (Nutrition Requirements Service)

#### 서비스 개요
- **목적**: NASEM 기준 영양 요구량 계산
- **기술 스택**: FastAPI, NumPy, SciPy, Redis
- **포트**: 8004

#### 데이터 모델
```python
# Animal Input Data
class AnimalInput(BaseModel):
    animal_id: UUID
    breed: BreedType
    stage: PhysiologicalStage
    weight: float
    age_months: int
    bcs: float
    milk_yield: float
    milk_fat: float
    milk_protein: float
    target_adg: float
    pregnancy_day: int
    environment_temp: float

# Nutrition Requirements
class NutritionRequirements(BaseModel):
    animal_id: UUID
    maintenance_energy: float
    maintenance_protein: float
    growth_energy: float
    growth_protein: float
    lactation_energy: float
    lactation_protein: float
    pregnancy_energy: float
    pregnancy_protein: float
    total_energy: float
    total_protein: float
    calculated_at: datetime
```

#### API 엔드포인트
```python
# 영양 요구량 계산
POST /nutrition/calculate-requirements
GET /nutrition/requirements/{animal_id}
GET /nutrition/requirements/{animal_id}/history

# 계산 설정
GET /nutrition/calculation-settings
PUT /nutrition/calculation-settings

# 환경 보정
POST /nutrition/environment-adjustment
POST /nutrition/stress-adjustment

# 품종별 특성
GET /nutrition/breed-characteristics
PUT /nutrition/breed-characteristics
```

#### 주요 기능
- NASEM(2024) 알고리즘 구현
- 생리적 단계별 계산
- 환경 요인 보정
- 품종별 특성 반영
- 계산 결과 캐싱
- 계산 이력 관리

---

### 5. 사료 배합 최적화 서비스 (Feed Formulation Service)

#### 서비스 개요
- **목적**: 선형계획법을 통한 최적 사료 배합
- **기술 스택**: FastAPI, PuLP, NumPy, Redis
- **포트**: 8005

#### 데이터 모델
```python
# Formulation Input
class FormulationInput(BaseModel):
    animal_id: UUID
    target_dmi: float
    available_feeds: List[UUID]
    nutrient_constraints: Dict[str, NutrientConstraint]
    cost_objective: bool
    environmental_objective: bool

# Nutrient Constraint
class NutrientConstraint(BaseModel):
    nutrient: str
    min_value: float
    max_value: float
    unit: str

# Formulation Result
class FormulationResult(BaseModel):
    id: UUID
    animal_id: UUID
    feed_mixture: Dict[str, float]  # feed_id: percentage
    total_cost: float
    nutrient_composition: Dict[str, float]
    constraint_satisfaction: Dict[str, bool]
    optimization_status: str
    created_at: datetime
```

#### API 엔드포인트
```python
# 배합 최적화
POST /formulation/optimize
GET /formulation/results/{result_id}
GET /formulation/history/{animal_id}

# 제약조건 관리
GET /formulation/constraints
POST /formulation/constraints
PUT /formulation/constraints/{constraint_id}

# 배합 검증
POST /formulation/validate
POST /formulation/compare

# 비용 분석
GET /formulation/cost-analysis/{result_id}
POST /formulation/cost-sensitivity
```

#### 주요 기능
- 선형계획법 최적화 (PuLP)
- 다중 목표 최적화
- 제약조건 관리
- 배합 검증
- 비용 민감도 분석
- 대안 배합 제시

---

### 6. 영양 분석 서비스 (Nutrition Analysis Service)

#### 서비스 개요
- **목적**: 영양소 분석, 균형 평가, 진단
- **기술 스택**: FastAPI, NumPy, Pandas
- **포트**: 8006

#### 데이터 모델
```python
# Nutrition Analysis Input
class NutritionAnalysisInput(BaseModel):
    animal_id: UUID
    feed_mixture: Dict[str, float]
    current_intake: float

# Nutrition Analysis Result
class NutritionAnalysisResult(BaseModel):
    id: UUID
    animal_id: UUID
    nutrient_composition: Dict[str, float]
    nutrient_ratios: Dict[str, float]
    balance_score: float
    deficiencies: List[str]
    excesses: List[str]
    recommendations: List[str]
    created_at: datetime
```

#### API 엔드포인트
```python
# 영양 분석
POST /analysis/analyze-nutrition
GET /analysis/results/{result_id}
GET /analysis/history/{animal_id}

# 균형 평가
POST /analysis/balance-assessment
GET /analysis/balance-scores

# 진단 및 제안
POST /analysis/diagnose
POST /analysis/recommendations

# 비교 분석
POST /analysis/compare
GET /analysis/trends/{animal_id}
```

#### 주요 기능
- 영양소 함량 계산
- 영양소 비율 분석
- 균형 점수 계산
- 부족/과잉 진단
- 개선 방안 제안
- 트렌드 분석

---

### 7. 섭취량 예측 서비스 (Intake Prediction Service)

#### 서비스 개요
- **목적**: 사료 섭취량 예측 및 분석
- **기술 스택**: FastAPI, Scikit-learn, NumPy
- **포트**: 8007

#### 데이터 모델
```python
# Intake Prediction Input
class IntakePredictionInput(BaseModel):
    animal_id: UUID
    feed_mixture: Dict[str, float]
    environmental_factors: EnvironmentalFactors
    historical_data: List[HistoricalIntake]

# Environmental Factors
class EnvironmentalFactors(BaseModel):
    temperature: float
    humidity: float
    season: str
    stress_level: float

# Intake Prediction Result
class IntakePredictionResult(BaseModel):
    id: UUID
    animal_id: UUID
    predicted_intake: float
    confidence_interval: Tuple[float, float]
    factors_impact: Dict[str, float]
    recommendations: List[str]
    created_at: datetime
```

#### API 엔드포인트
```python
# 섭취량 예측
POST /intake/predict
GET /intake/predictions/{prediction_id}
GET /intake/history/{animal_id}

# 모델 관리
GET /intake/models
POST /intake/models/train
PUT /intake/models/{model_id}

# 정확도 평가
POST /intake/accuracy-assessment
GET /intake/accuracy-metrics

# 환경 영향 분석
POST /intake/environmental-impact
GET /intake/seasonal-patterns
```

#### 주요 기능
- 머신러닝 기반 예측
- 환경 요인 반영
- 계절성 패턴 분석
- 예측 정확도 평가
- 모델 자동 학습
- 개체별 차이 보정

---

### 8. 보고서 생성 서비스 (Report Generation Service)

#### 서비스 개요
- **목적**: 다양한 형태의 보고서 생성
- **기술 스택**: FastAPI, ReportLab, Pandas, MinIO
- **포트**: 8008

#### 데이터 모델
```python
# Report Template
class ReportTemplate(BaseModel):
    id: UUID
    name: str
    type: ReportType
    template_data: Dict
    created_at: datetime

# Report Request
class ReportRequest(BaseModel):
    template_id: UUID
    data_source: Dict[str, Any]
    format: ReportFormat
    parameters: Dict[str, Any]

# Generated Report
class GeneratedReport(BaseModel):
    id: UUID
    template_id: UUID
    file_url: str
    file_size: int
    format: ReportFormat
    generated_at: datetime
    expires_at: datetime
```

#### API 엔드포인트
```python
# 보고서 생성
POST /reports/generate
GET /reports/{report_id}
GET /reports/{report_id}/download

# 템플릿 관리
GET /reports/templates
POST /reports/templates
PUT /reports/templates/{template_id}
DELETE /reports/templates/{template_id}

# 보고서 이력
GET /reports/history
GET /reports/history/{user_id}

# 데이터 내보내기
POST /reports/export
GET /reports/export/{export_id}
```

#### 주요 기능
- PDF 보고서 생성
- Excel 데이터 내보내기
- 차트 및 그래프 생성
- 맞춤형 템플릿
- 자동 보고서 스케줄링
- 보고서 공유

---

### 9. 알림 서비스 (Notification Service)

#### 서비스 개요
- **목적**: 다양한 알림 및 경고 관리
- **기술 스택**: FastAPI, RabbitMQ, Redis
- **포트**: 8009

#### 데이터 모델
```python
# Notification Template
class NotificationTemplate(BaseModel):
    id: UUID
    name: str
    type: NotificationType
    title_template: str
    body_template: str
    channels: List[NotificationChannel]

# Notification
class Notification(BaseModel):
    id: UUID
    user_id: UUID
    template_id: UUID
    title: str
    body: str
    data: Dict[str, Any]
    channels: List[NotificationChannel]
    status: NotificationStatus
    sent_at: datetime
    read_at: datetime

# Notification Rule
class NotificationRule(BaseModel):
    id: UUID
    user_id: UUID
    name: str
    conditions: Dict[str, Any]
    template_id: UUID
    is_active: bool
    created_at: datetime
```

#### API 엔드포인트
```python
# 알림 관리
GET /notifications
POST /notifications
GET /notifications/{notification_id}
PUT /notifications/{notification_id}/read
DELETE /notifications/{notification_id}

# 템플릿 관리
GET /notifications/templates
POST /notifications/templates
PUT /notifications/templates/{template_id}

# 규칙 관리
GET /notifications/rules
POST /notifications/rules
PUT /notifications/rules/{rule_id}
DELETE /notifications/rules/{rule_id}

# 설정 관리
GET /notifications/settings
PUT /notifications/settings
```

#### 주요 기능
- 이메일 알림
- SMS 알림
- 푸시 알림
- 웹 알림
- 알림 규칙 설정
- 알림 이력 관리

---

### 10. 데이터 분석 서비스 (Analytics Service)

#### 서비스 개요
- **목적**: 사용 패턴 분석 및 비즈니스 인사이트
- **기술 스택**: FastAPI, Pandas, NumPy, Elasticsearch
- **포트**: 8010

#### 데이터 모델
```python
# Analytics Event
class AnalyticsEvent(BaseModel):
    id: UUID
    user_id: UUID
    event_type: str
    event_data: Dict[str, Any]
    timestamp: datetime
    session_id: str

# Analytics Metric
class AnalyticsMetric(BaseModel):
    id: UUID
    metric_name: str
    metric_value: float
    dimensions: Dict[str, Any]
    timestamp: datetime

# Analytics Report
class AnalyticsReport(BaseModel):
    id: UUID
    report_type: str
    data: Dict[str, Any]
    generated_at: datetime
    expires_at: datetime
```

#### API 엔드포인트
```python
# 이벤트 추적
POST /analytics/events
GET /analytics/events

# 메트릭 수집
POST /analytics/metrics
GET /analytics/metrics

# 분석 리포트
GET /analytics/reports
POST /analytics/reports/generate
GET /analytics/reports/{report_id}

# 대시보드
GET /analytics/dashboard
GET /analytics/dashboard/{dashboard_id}

# 사용자 행동 분석
GET /analytics/user-behavior
GET /analytics/user-behavior/{user_id}
```

#### 주요 기능
- 사용자 행동 추적
- 성능 메트릭 수집
- 비즈니스 분석
- 예측 분석
- 실시간 대시보드
- 커스텀 리포트

---

## 🔄 서비스 간 통신

### 동기 통신 (REST API)
```python
# 서비스 간 HTTP 통신
import httpx

async def get_user_info(user_id: str):
    async with httpx.AsyncClient() as client:
        response = await client.get(f"http://user-service:8001/users/{user_id}")
        return response.json()
```

### 비동기 통신 (RabbitMQ)
```python
# 이벤트 발행
import pika

def publish_event(event_type: str, event_data: dict):
    connection = pika.BlockingConnection(pika.ConnectionParameters('rabbitmq'))
    channel = connection.channel()
    channel.basic_publish(
        exchange='cnucnm_events',
        routing_key=event_type,
        body=json.dumps(event_data)
    )
```

## 📊 서비스 모니터링

### 헬스 체크
```python
# 각 서비스의 헬스 체크 엔드포인트
GET /health
GET /health/ready
GET /health/live
```

### 메트릭 수집
```python
# Prometheus 메트릭
from prometheus_client import Counter, Histogram

request_count = Counter('http_requests_total', 'Total HTTP requests')
request_duration = Histogram('http_request_duration_seconds', 'HTTP request duration')
```

---

*이 문서는 각 마이크로서비스의 상세한 설계와 API 명세를 정의하며, 개발 및 구현의 구체적인 가이드라인을 제공합니다.*
