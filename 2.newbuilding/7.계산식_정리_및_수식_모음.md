# 7. CNUCNM 계산식 정리 및 수식 모음

## 📊 개요

이 문서는 CNUCNM 시스템에서 사용되는 모든 계산식과 수식을 체계적으로 정리한 것입니다. NASEM(2024) 기준에 따른 소의 영양 요구량 계산과 사료 배합 최적화에 필요한 핵심 수식들을 포함합니다.

## 🔢 기본 상수 및 변환 계수

### 체중 변환 계수
```python
# 기본 변환 계수
q_FBW_SBW = 0.96      # FBW(Final Body Weight) → SBW(Shrunk Body Weight)
q_SBW_EBW = 0.891     # SBW → EBW(Empty Body Weight)
q_ADG_SWG = 1.0       # ADG(Average Daily Gain) → SWG(Shrunk Weight Gain)
q_SWG_EWG = 0.956     # SWG → EWG(Empty Weight Gain)

# 단백질 변환 계수
q_MCP_MP = 0.64       # MCP(Microbial Crude Protein) → MP(Metabolizable Protein)
q_RUP_MP = 0.80       # RUP(Rumen Undegradable Protein) → MP

# 기타 상수
month_day = 30.4      # 월별 일수
pregnancy_day = 283   # 임신 기간 (일)
milk_cp_tp = 0.951    # 우유 CP → TP(True Protein) 변환 계수
```

### 참조값 (2024년 검정우 평균)
```python
# 생산성 기준값
rha_KDIA = 10159      # 305일 유량 (kg)
ref_milk_yield_kg = rha_KDIA / 305  # 평균 일일 유량 (kg)
ref_milk_fat_p = 4.02 # 유지방 (%)
ref_milk_cp_p = 3.22  # 유단백 (%)
ref_milk_tp_p = ref_milk_cp_p * milk_cp_tp  # 유진단백 (%)

# 번식 관련
age_at_first_calving = 26.8  # 첫 분만 연령 (개월)
ci_month = 447.7 / 30.4      # 분만 간격 (개월)
```

## 🐄 체중 및 체형 관련 계산

### 체중 변환 공식
```python
def convert_body_weight(fbw, conversion_type):
    """
    체중 변환 함수
    
    Args:
        fbw: Final Body Weight (kg)
        conversion_type: 변환 유형 ('SBW', 'EBW')
    
    Returns:
        변환된 체중 (kg)
    """
    if conversion_type == 'SBW':
        return fbw * q_FBW_SBW
    elif conversion_type == 'EBW':
        sbw = fbw * q_FBW_SBW
        return sbw * q_SBW_EBW
    else:
        raise ValueError("Invalid conversion type")

# 사용 예시
sbw = convert_body_weight(fbw=600, conversion_type='SBW')  # 576 kg
ebw = convert_body_weight(fbw=600, conversion_type='EBW')  # 513 kg
```

### 성장 관련 계산
```python
def calculate_weight_gain(adg, gain_type):
    """
    증체량 변환 함수
    
    Args:
        adg: Average Daily Gain (kg/day)
        gain_type: 증체 유형 ('SWG', 'EWG')
    
    Returns:
        변환된 증체량 (kg/day)
    """
    if gain_type == 'SWG':
        return adg * q_ADG_SWG
    elif gain_type == 'EWG':
        swg = adg * q_ADG_SWG
        return swg * q_SWG_EWG
    else:
        raise ValueError("Invalid gain type")

# 사용 예시
swg = calculate_weight_gain(adg=1.2, gain_type='SWG')  # 1.2 kg/day
ewg = calculate_weight_gain(adg=1.2, gain_type='EWG')  # 1.15 kg/day
```

## 🔋 에너지 요구량 계산

### 유지 에너지 요구량 (Maintenance Energy)

#### 기본 유지 에너지 (Fasting Heat Production, FHP)
```python
def calculate_fhp(ebw, breed, stage):
    """
    Fasting Heat Production 계산
    
    Args:
        ebw: Empty Body Weight (kg)
        breed: 품종 ('hanwoo', 'holstein')
        stage: 생리적 단계 ('calf', 'growing', 'lactating', 'drying')
    
    Returns:
        FHP (Mcal/day)
    """
    # 품종별 FHP 계수
    fhp_coefficients = {
        'hanwoo': {
            'calf': 0.07,
            'growing': 0.07,
            'fattening': 0.07,
            'lactating': 0.084,
            'drying': 0.07
        },
        'holstein': {
            'calf': 0.07,
            'growing': 0.07,
            'fattening': 0.07,
            'lactating': 0.084,
            'drying': 0.07
        }
    }
    
    coefficient = fhp_coefficients[breed][stage]
    fhp = coefficient * (ebw ** 0.75)
    
    return fhp

# 사용 예시
fhp = calculate_fhp(ebw=513, breed='hanwoo', stage='lactating')  # 36.9 Mcal/day
```

#### 활동 에너지 (Activity Energy)
```python
def calculate_activity_energy(ebw, activity_level='normal'):
    """
    활동 에너지 계산
    
    Args:
        ebw: Empty Body Weight (kg)
        activity_level: 활동 수준 ('low', 'normal', 'high')
    
    Returns:
        활동 에너지 (Mcal/day)
    """
    activity_coefficients = {
        'low': 0.005,
        'normal': 0.010,
        'high': 0.015
    }
    
    coefficient = activity_coefficients[activity_level]
    activity_energy = coefficient * (ebw ** 0.75)
    
    return activity_energy

# 사용 예시
activity_energy = calculate_activity_energy(ebw=513, activity_level='normal')  # 5.3 Mcal/day
```

#### 총 유지 에너지 (Total Maintenance Energy)
```python
def calculate_maintenance_energy(ebw, breed, stage, activity_level='normal'):
    """
    총 유지 에너지 계산
    
    Args:
        ebw: Empty Body Weight (kg)
        breed: 품종
        stage: 생리적 단계
        activity_level: 활동 수준
    
    Returns:
        총 유지 에너지 (Mcal/day)
    """
    fhp = calculate_fhp(ebw, breed, stage)
    activity = calculate_activity_energy(ebw, activity_level)
    
    total_maintenance = fhp + activity
    return total_maintenance

# 사용 예시
maintenance_energy = calculate_maintenance_energy(
    ebw=513, breed='hanwoo', stage='lactating'
)  # 42.2 Mcal/day
```

### 성장 에너지 요구량 (Growth Energy)

#### 성장 에너지 계산
```python
def calculate_growth_energy(ewg, ebw, breed):
    """
    성장 에너지 요구량 계산
    
    Args:
        ewg: Empty Weight Gain (kg/day)
        ebw: Empty Body Weight (kg)
        breed: 품종
    
    Returns:
        성장 에너지 (Mcal/day)
    """
    # 성장 에너지 계수 (Mcal/kg gain)
    growth_coefficients = {
        'hanwoo': 4.5,
        'holstein': 4.8
    }
    
    coefficient = growth_coefficients[breed]
    growth_energy = coefficient * ewg
    
    return growth_energy

# 사용 예시
growth_energy = calculate_growth_energy(
    ewg=1.15, ebw=513, breed='hanwoo'
)  # 5.2 Mcal/day
```

### 번식 에너지 요구량 (Pregnancy Energy)

#### 임신 에너지 계산
```python
def calculate_pregnancy_energy(gestation_day, breed):
    """
    임신 에너지 요구량 계산
    
    Args:
        gestation_day: 임신일수
        breed: 품종
    
    Returns:
        임신 에너지 (Mcal/day)
    """
    if gestation_day <= 0 or gestation_day > 283:
        return 0
    
    # 임신 에너지 계수
    pregnancy_coefficients = {
        'hanwoo': 0.0008,
        'holstein': 0.0009
    }
    
    coefficient = pregnancy_coefficients[breed]
    pregnancy_energy = coefficient * (gestation_day ** 2)
    
    return pregnancy_energy

# 사용 예시
pregnancy_energy = calculate_pregnancy_energy(
    gestation_day=200, breed='hanwoo'
)  # 32.0 Mcal/day
```

### 유산 에너지 요구량 (Lactation Energy)

#### 유산 에너지 계산
```python
def calculate_lactation_energy(milk_yield, milk_fat, milk_protein):
    """
    유산 에너지 요구량 계산
    
    Args:
        milk_yield: 일일 유량 (kg/day)
        milk_fat: 유지방 (%)
        milk_protein: 유단백 (%)
    
    Returns:
        유산 에너지 (Mcal/day)
    """
    # 우유 에너지 함량 계산 (Mcal/kg)
    milk_energy = 0.0929 * milk_fat + 0.0563 * milk_protein + 0.192
    
    # 총 유산 에너지
    lactation_energy = milk_yield * milk_energy
    
    return lactation_energy

# 사용 예시
lactation_energy = calculate_lactation_energy(
    milk_yield=25.0, milk_fat=4.02, milk_protein=3.22
)  # 18.5 Mcal/day
```

### 총 에너지 요구량 (Total Energy Requirements)
```python
def calculate_total_energy_requirements(
    ebw, breed, stage, ewg=0, gestation_day=0, 
    milk_yield=0, milk_fat=4.02, milk_protein=3.22,
    activity_level='normal'
):
    """
    총 에너지 요구량 계산
    
    Args:
        ebw: Empty Body Weight (kg)
        breed: 품종
        stage: 생리적 단계
        ewg: Empty Weight Gain (kg/day)
        gestation_day: 임신일수
        milk_yield: 일일 유량 (kg/day)
        milk_fat: 유지방 (%)
        milk_protein: 유단백 (%)
        activity_level: 활동 수준
    
    Returns:
        총 에너지 요구량 (Mcal/day)
    """
    # 각 구성 요소 계산
    maintenance = calculate_maintenance_energy(ebw, breed, stage, activity_level)
    growth = calculate_growth_energy(ewg, ebw, breed) if ewg > 0 else 0
    pregnancy = calculate_pregnancy_energy(gestation_day, breed)
    lactation = calculate_lactation_energy(milk_yield, milk_fat, milk_protein)
    
    # 총 에너지 요구량
    total_energy = maintenance + growth + pregnancy + lactation
    
    return {
        'maintenance': maintenance,
        'growth': growth,
        'pregnancy': pregnancy,
        'lactation': lactation,
        'total': total_energy
    }

# 사용 예시
energy_requirements = calculate_total_energy_requirements(
    ebw=513, breed='hanwoo', stage='lactating',
    ewg=0, gestation_day=0, milk_yield=25.0
)
# 결과: {'maintenance': 42.2, 'growth': 0, 'pregnancy': 0, 'lactation': 18.5, 'total': 60.7}
```

## 🥩 단백질 요구량 계산

### 유지 단백질 요구량 (Maintenance Protein)

#### 내인성 요실 (Endogenous Urinary Loss)
```python
def calculate_endogenous_loss(ebw):
    """
    내인성 요실 계산
    
    Args:
        ebw: Empty Body Weight (kg)
    
    Returns:
        내인성 요실 (g/day)
    """
    endogenous_loss = 0.2 * (ebw ** 0.75)
    return endogenous_loss

# 사용 예시
endogenous_loss = calculate_endogenous_loss(ebw=513)  # 8.2 g/day
```

#### 대사성 요실 (Metabolic Fecal Loss)
```python
def calculate_metabolic_loss(dmi):
    """
    대사성 요실 계산
    
    Args:
        dmi: Dry Matter Intake (kg/day)
    
    Returns:
        대사성 요실 (g/day)
    """
    metabolic_loss = 30 * dmi
    return metabolic_loss

# 사용 예시
metabolic_loss = calculate_metabolic_loss(dmi=20.0)  # 600 g/day
```

#### 총 유지 단백질 요구량
```python
def calculate_maintenance_protein(ebw, dmi):
    """
    총 유지 단백질 요구량 계산
    
    Args:
        ebw: Empty Body Weight (kg)
        dmi: Dry Matter Intake (kg/day)
    
    Returns:
        유지 단백질 요구량 (g/day)
    """
    endogenous = calculate_endogenous_loss(ebw)
    metabolic = calculate_metabolic_loss(dmi)
    
    total_maintenance = endogenous + metabolic
    return total_maintenance

# 사용 예시
maintenance_protein = calculate_maintenance_protein(ebw=513, dmi=20.0)  # 608.2 g/day
```

### 성장 단백질 요구량 (Growth Protein)

#### 성장 단백질 계산
```python
def calculate_growth_protein(ewg, ebw, breed):
    """
    성장 단백질 요구량 계산
    
    Args:
        ewg: Empty Weight Gain (kg/day)
        ebw: Empty Body Weight (kg)
        breed: 품종
    
    Returns:
        성장 단백질 요구량 (g/day)
    """
    # 성장 단백질 계수 (g/kg gain)
    growth_protein_coefficients = {
        'hanwoo': 180,
        'holstein': 190
    }
    
    coefficient = growth_protein_coefficients[breed]
    growth_protein = coefficient * ewg
    
    return growth_protein

# 사용 예시
growth_protein = calculate_growth_protein(
    ewg=1.15, ebw=513, breed='hanwoo'
)  # 207 g/day
```

### 번식 단백질 요구량 (Pregnancy Protein)

#### 임신 단백질 계산
```python
def calculate_pregnancy_protein(gestation_day, breed):
    """
    임신 단백질 요구량 계산
    
    Args:
        gestation_day: 임신일수
        breed: 품종
    
    Returns:
        임신 단백질 요구량 (g/day)
    """
    if gestation_day <= 0 or gestation_day > 283:
        return 0
    
    # 임신 단백질 계수
    pregnancy_protein_coefficients = {
        'hanwoo': 0.003,
        'holstein': 0.0035
    }
    
    coefficient = pregnancy_protein_coefficients[breed]
    pregnancy_protein = coefficient * (gestation_day ** 2)
    
    return pregnancy_protein

# 사용 예시
pregnancy_protein = calculate_pregnancy_protein(
    gestation_day=200, breed='hanwoo'
)  # 120 g/day
```

### 유산 단백질 요구량 (Lactation Protein)

#### 유산 단백질 계산
```python
def calculate_lactation_protein(milk_yield, milk_protein):
    """
    유산 단백질 요구량 계산
    
    Args:
        milk_yield: 일일 유량 (kg/day)
        milk_protein: 유단백 (%)
    
    Returns:
        유산 단백질 요구량 (g/day)
    """
    # 우유 단백질 함량 (g/kg)
    milk_protein_content = milk_protein * 10
    
    # 총 유산 단백질
    lactation_protein = milk_yield * milk_protein_content
    
    return lactation_protein

# 사용 예시
lactation_protein = calculate_lactation_protein(
    milk_yield=25.0, milk_protein=3.22
)  # 805 g/day
```

### 총 단백질 요구량 (Total Protein Requirements)
```python
def calculate_total_protein_requirements(
    ebw, breed, dmi, ewg=0, gestation_day=0, 
    milk_yield=0, milk_protein=3.22
):
    """
    총 단백질 요구량 계산
    
    Args:
        ebw: Empty Body Weight (kg)
        breed: 품종
        dmi: Dry Matter Intake (kg/day)
        ewg: Empty Weight Gain (kg/day)
        gestation_day: 임신일수
        milk_yield: 일일 유량 (kg/day)
        milk_protein: 유단백 (%)
    
    Returns:
        총 단백질 요구량 (g/day)
    """
    # 각 구성 요소 계산
    maintenance = calculate_maintenance_protein(ebw, dmi)
    growth = calculate_growth_protein(ewg, ebw, breed) if ewg > 0 else 0
    pregnancy = calculate_pregnancy_protein(gestation_day, breed)
    lactation = calculate_lactation_protein(milk_yield, milk_protein)
    
    # 총 단백질 요구량
    total_protein = maintenance + growth + pregnancy + lactation
    
    return {
        'maintenance': maintenance,
        'growth': growth,
        'pregnancy': pregnancy,
        'lactation': lactation,
        'total': total_protein
    }

# 사용 예시
protein_requirements = calculate_total_protein_requirements(
    ebw=513, breed='hanwoo', dmi=20.0,
    ewg=0, gestation_day=0, milk_yield=25.0
)
# 결과: {'maintenance': 608.2, 'growth': 0, 'pregnancy': 0, 'lactation': 805, 'total': 1413.2}
```

## 🥗 사료 배합 최적화 (Linear Programming)

### 목적 함수 (Objective Function)
```python
def objective_function(feed_variables, feed_prices):
    """
    비용 최소화 목적 함수
    
    Args:
        feed_variables: 사료 변수 (kg)
        feed_prices: 사료 가격 (원/kg)
    
    Returns:
        총 비용 (원)
    """
    total_cost = sum(feed_variables[i] * feed_prices[i] for i in range(len(feed_variables)))
    return total_cost
```

### 제약 조건 (Constraints)

#### 영양소 제약 조건
```python
def nutrient_constraints(feed_variables, feed_nutrients, requirements):
    """
    영양소 제약 조건
    
    Args:
        feed_variables: 사료 변수 (kg)
        feed_nutrients: 사료별 영양소 함량
        requirements: 영양소 요구량
    
    Returns:
        제약 조건 리스트
    """
    constraints = []
    
    for nutrient in requirements:
        min_value = requirements[nutrient]['min']
        max_value = requirements[nutrient]['max']
        
        # 최소 제약 조건
        min_constraint = sum(
            feed_variables[i] * feed_nutrients[i][nutrient] 
            for i in range(len(feed_variables))
        ) >= min_value
        
        # 최대 제약 조건
        max_constraint = sum(
            feed_variables[i] * feed_nutrients[i][nutrient] 
            for i in range(len(feed_variables))
        ) <= max_value
        
        constraints.extend([min_constraint, max_constraint])
    
    return constraints
```

#### 사료 비율 제약 조건
```python
def feed_ratio_constraints(feed_variables, min_ratios, max_ratios, total_dmi):
    """
    사료 비율 제약 조건
    
    Args:
        feed_variables: 사료 변수 (kg)
        min_ratios: 최소 비율 (%)
        max_ratios: 최대 비율 (%)
        total_dmi: 총 건물 섭취량 (kg)
    
    Returns:
        제약 조건 리스트
    """
    constraints = []
    
    for i in range(len(feed_variables)):
        # 최소 비율 제약
        min_constraint = feed_variables[i] >= (min_ratios[i] / 100) * total_dmi
        
        # 최대 비율 제약
        max_constraint = feed_variables[i] <= (max_ratios[i] / 100) * total_dmi
        
        constraints.extend([min_constraint, max_constraint])
    
    return constraints
```

#### 총량 제약 조건
```python
def total_amount_constraint(feed_variables, total_dmi):
    """
    총량 제약 조건
    
    Args:
        feed_variables: 사료 변수 (kg)
        total_dmi: 총 건물 섭취량 (kg)
    
    Returns:
        제약 조건
    """
    return sum(feed_variables) == total_dmi
```

### 최적화 문제 풀이
```python
from pulp import *

def solve_feed_formulation(feed_data, requirements, total_dmi):
    """
    사료 배합 최적화 문제 풀이
    
    Args:
        feed_data: 사료 데이터 (가격, 영양소 함량)
        requirements: 영양소 요구량
        total_dmi: 총 건물 섭취량 (kg)
    
    Returns:
        최적 배합 결과
    """
    # 문제 정의
    prob = LpProblem("Feed_Formulation", LpMinimize)
    
    # 변수 정의
    feed_vars = []
    for i in range(len(feed_data)):
        var = LpVariable(f"feed_{i}", 0, None)
        feed_vars.append(var)
    
    # 목적 함수 (비용 최소화)
    prob += lpSum([feed_vars[i] * feed_data[i]['price'] for i in range(len(feed_data))])
    
    # 제약 조건 추가
    # 1. 영양소 제약 조건
    for nutrient in requirements:
        min_val = requirements[nutrient]['min']
        max_val = requirements[nutrient]['max']
        
        prob += lpSum([feed_vars[i] * feed_data[i][nutrient] for i in range(len(feed_data))]) >= min_val
        prob += lpSum([feed_vars[i] * feed_data[i][nutrient] for i in range(len(feed_data))]) <= max_val
    
    # 2. 총량 제약 조건
    prob += lpSum(feed_vars) == total_dmi
    
    # 문제 풀이
    prob.solve()
    
    # 결과 반환
    if LpStatus[prob.status] == 'Optimal':
        result = {
            'status': 'optimal',
            'total_cost': value(prob.objective),
            'feed_mixture': [value(var) for var in feed_vars],
            'nutrient_composition': {}
        }
        
        # 영양소 조성 계산
        for nutrient in requirements:
            result['nutrient_composition'][nutrient] = sum(
                value(feed_vars[i]) * feed_data[i][nutrient] 
                for i in range(len(feed_data))
            )
        
        return result
    else:
        return {'status': 'infeasible', 'message': 'No feasible solution found'}

# 사용 예시
feed_data = [
    {'name': 'Corn', 'price': 300, 'cp': 8.5, 'energy': 3.2, 'ndf': 9.0},
    {'name': 'Soybean', 'price': 800, 'cp': 44.0, 'energy': 3.8, 'ndf': 7.0},
    {'name': 'Alfalfa', 'price': 500, 'cp': 18.0, 'energy': 2.1, 'ndf': 45.0}
]

requirements = {
    'cp': {'min': 16.0, 'max': 18.0},
    'energy': {'min': 2.8, 'max': 3.2},
    'ndf': {'min': 25.0, 'max': 35.0}
}

result = solve_feed_formulation(feed_data, requirements, total_dmi=20.0)
```

## 🔍 섭취량 예측

### 체중 기반 섭취량 예측
```python
def predict_dmi_by_weight(bw, stage, breed):
    """
    체중 기반 건물 섭취량 예측
    
    Args:
        bw: Body Weight (kg)
        stage: 생리적 단계
        breed: 품종
    
    Returns:
        예상 건물 섭취량 (kg/day)
    """
    # 체중 기반 계수
    weight_coefficients = {
        'hanwoo': {
            'calf': 0.025,
            'growing': 0.022,
            'lactating': 0.030,
            'drying': 0.018
        },
        'holstein': {
            'calf': 0.025,
            'growing': 0.022,
            'lactating': 0.032,
            'drying': 0.018
        }
    }
    
    coefficient = weight_coefficients[breed][stage]
    dmi = coefficient * bw
    
    return dmi

# 사용 예시
dmi = predict_dmi_by_weight(bw=600, stage='lactating', breed='hanwoo')  # 18.0 kg/day
```

### 생산성 기반 섭취량 조정
```python
def adjust_dmi_by_production(base_dmi, milk_yield, milk_fat):
    """
    생산성 기반 섭취량 조정
    
    Args:
        base_dmi: 기본 건물 섭취량 (kg/day)
        milk_yield: 일일 유량 (kg/day)
        milk_fat: 유지방 (%)
    
    Returns:
        조정된 건물 섭취량 (kg/day)
    """
    # 유량에 따른 조정 계수
    milk_adjustment = 0.2 * milk_yield
    
    # 유지방에 따른 조정 계수
    fat_adjustment = 0.1 * milk_fat
    
    adjusted_dmi = base_dmi + milk_adjustment + fat_adjustment
    
    return adjusted_dmi

# 사용 예시
adjusted_dmi = adjust_dmi_by_production(
    base_dmi=18.0, milk_yield=25.0, milk_fat=4.02
)  # 23.4 kg/day
```

## 🌡️ 환경 보정

### 온도 보정
```python
def temperature_adjustment(base_requirement, temperature, breed):
    """
    온도에 따른 요구량 보정
    
    Args:
        base_requirement: 기본 요구량
        temperature: 환경 온도 (°C)
        breed: 품종
    
    Returns:
        보정된 요구량
    """
    # 온도 보정 계수
    temp_coefficients = {
        'hanwoo': 0.02,  # 한우는 추위에 강함
        'holstein': 0.025  # 홀스타인은 추위에 민감
    }
    
    coefficient = temp_coefficients[breed]
    
    if temperature < 5:
        # 저온 보정
        adjustment = coefficient * (5 - temperature)
        adjusted_requirement = base_requirement * (1 + adjustment)
    elif temperature > 25:
        # 고온 보정
        adjustment = coefficient * (temperature - 25)
        adjusted_requirement = base_requirement * (1 + adjustment)
    else:
        adjusted_requirement = base_requirement
    
    return adjusted_requirement

# 사용 예시
adjusted_energy = temperature_adjustment(
    base_requirement=60.7, temperature=30, breed='hanwoo'
)  # 62.4 Mcal/day
```

## 📊 영양소 균형 분석

### 영양소 비율 계산
```python
def calculate_nutrient_ratios(nutrient_composition):
    """
    영양소 비율 계산
    
    Args:
        nutrient_composition: 영양소 조성 (g/kg DM)
    
    Returns:
        영양소 비율
    """
    ratios = {}
    
    # CP:NDF 비율
    if nutrient_composition['ndf'] > 0:
        ratios['cp_ndf'] = nutrient_composition['cp'] / nutrient_composition['ndf']
    
    # NFC:NDF 비율
    if nutrient_composition['ndf'] > 0:
        ratios['nfc_ndf'] = nutrient_composition['nfc'] / nutrient_composition['ndf']
    
    # Ca:P 비율
    if nutrient_composition['p'] > 0:
        ratios['ca_p'] = nutrient_composition['ca'] / nutrient_composition['p']
    
    return ratios

# 사용 예시
nutrient_composition = {
    'cp': 16.5, 'ndf': 30.0, 'nfc': 45.0, 'ca': 0.8, 'p': 0.4
}
ratios = calculate_nutrient_ratios(nutrient_composition)
# 결과: {'cp_ndf': 0.55, 'nfc_ndf': 1.5, 'ca_p': 2.0}
```

### 균형 점수 계산
```python
def calculate_balance_score(nutrient_composition, requirements):
    """
    영양소 균형 점수 계산
    
    Args:
        nutrient_composition: 영양소 조성
        requirements: 영양소 요구량
    
    Returns:
        균형 점수 (0-100)
    """
    score = 100
    penalties = 0
    
    for nutrient in requirements:
        actual = nutrient_composition.get(nutrient, 0)
        min_req = requirements[nutrient]['min']
        max_req = requirements[nutrient]['max']
        
        if actual < min_req:
            # 부족 페널티
            deficiency = (min_req - actual) / min_req
            penalties += deficiency * 20
        elif actual > max_req:
            # 과잉 페널티
            excess = (actual - max_req) / max_req
            penalties += excess * 15
    
    final_score = max(0, score - penalties)
    return final_score

# 사용 예시
balance_score = calculate_balance_score(nutrient_composition, requirements)  # 85.2
```

## 🔄 데이터 변환 및 유틸리티 함수

### 단위 변환
```python
def convert_units(value, from_unit, to_unit):
    """
    단위 변환 함수
    
    Args:
        value: 변환할 값
        from_unit: 원래 단위
        to_unit: 변환할 단위
    
    Returns:
        변환된 값
    """
    # 에너지 단위 변환
    energy_conversions = {
        'Mcal_to_MJ': 4.184,
        'MJ_to_Mcal': 0.239,
        'kcal_to_Mcal': 0.001,
        'Mcal_to_kcal': 1000
    }
    
    # 무게 단위 변환
    weight_conversions = {
        'kg_to_g': 1000,
        'g_to_kg': 0.001,
        'lb_to_kg': 0.4536,
        'kg_to_lb': 2.2046
    }
    
    # 길이 단위 변환
    length_conversions = {
        'cm_to_m': 0.01,
        'm_to_cm': 100,
        'inch_to_cm': 2.54,
        'cm_to_inch': 0.3937
    }
    
    # 모든 변환 테이블 통합
    all_conversions = {
        **energy_conversions,
        **weight_conversions,
        **length_conversions
    }
    
    conversion_key = f"{from_unit}_to_{to_unit}"
    
    if conversion_key in all_conversions:
        return value * all_conversions[conversion_key]
    else:
        raise ValueError(f"Unsupported unit conversion: {from_unit} to {to_unit}")

# 사용 예시
energy_mj = convert_units(60.7, 'Mcal', 'MJ')  # 253.9 MJ
weight_g = convert_units(1.5, 'kg', 'g')  # 1500 g
```

### 통계 함수
```python
import numpy as np

def calculate_statistics(data):
    """
    기본 통계 계산
    
    Args:
        data: 데이터 리스트
    
    Returns:
        통계 정보
    """
    if not data:
        return None
    
    stats = {
        'count': len(data),
        'mean': np.mean(data),
        'median': np.median(data),
        'std': np.std(data),
        'min': np.min(data),
        'max': np.max(data),
        'range': np.max(data) - np.min(data)
    }
    
    return stats

def calculate_percentile(data, percentile):
    """
    백분위수 계산
    
    Args:
        data: 데이터 리스트
        percentile: 백분위수 (0-100)
    
    Returns:
        백분위수 값
    """
    return np.percentile(data, percentile)

# 사용 예시
data = [15.2, 16.8, 14.9, 17.1, 16.3, 15.7]
stats = calculate_statistics(data)
# 결과: {'count': 6, 'mean': 16.0, 'median': 16.0, 'std': 0.8, 'min': 14.9, 'max': 17.1, 'range': 2.2}

p95 = calculate_percentile(data, 95)  # 17.0
```

## 📈 검증 및 검증 함수

### 계산 결과 검증
```python
def validate_calculation_results(energy_req, protein_req, dmi_pred):
    """
    계산 결과 검증
    
    Args:
        energy_req: 에너지 요구량 (Mcal/day)
        protein_req: 단백질 요구량 (g/day)
        dmi_pred: 예상 건물 섭취량 (kg/day)
    
    Returns:
        검증 결과
    """
    validation = {
        'energy_reasonable': 20 <= energy_req <= 100,
        'protein_reasonable': 500 <= protein_req <= 3000,
        'dmi_reasonable': 5 <= dmi_pred <= 30,
        'energy_density_reasonable': 2.0 <= (energy_req / dmi_pred) <= 4.0,
        'protein_density_reasonable': 8.0 <= (protein_req / dmi_pred) <= 25.0
    }
    
    all_valid = all(validation.values())
    
    return {
        'is_valid': all_valid,
        'validation_details': validation,
        'warnings': [k for k, v in validation.items() if not v]
    }

# 사용 예시
validation = validate_calculation_results(
    energy_req=60.7, protein_req=1413.2, dmi_pred=20.0
)
# 결과: {'is_valid': True, 'validation_details': {...}, 'warnings': []}
```

---

*이 문서는 CNUCNM 시스템의 모든 계산식과 수식을 체계적으로 정리한 것으로, Python으로 구현할 때 참고할 수 있는 완전한 수학적 기반을 제공합니다.*
