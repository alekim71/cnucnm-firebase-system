# 5. CNUCNM API 전략 및 명세

## 🎯 API 전략 개요

### API First 접근법
- **모든 기능을 API로 노출**: 웹, 모바일, 서드파티 통합
- **RESTful 설계**: 표준 HTTP 메서드와 상태 코드
- **OpenAPI 3.0 명세**: 자동 문서화 및 코드 생성
- **버전 관리**: API 버전별 호환성 보장

### API 게이트웨이 역할
- **단일 진입점**: 모든 API 요청의 중앙 집중화
- **인증 및 권한**: JWT 토큰 검증 및 RBAC
- **로드 밸런싱**: 트래픽 분산 및 장애 복구
- **레이트 리미팅**: API 사용량 제한
- **모니터링**: API 호출 통계 및 성능 측정

## 🏗️ API 게이트웨이 아키텍처

### Kong API Gateway 설정

```yaml
# kong.yml
_format_version: "2.1"
_transform: true

services:
  - name: user-service
    url: http://user-service:8001
    routes:
      - name: user-routes
        paths:
          - /api/v1/users
          - /api/v1/auth
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000

  - name: animal-service
    url: http://animal-service:8002
    routes:
      - name: animal-routes
        paths:
          - /api/v1/animals
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000

  - name: feed-library-service
    url: http://feed-library-service:8003
    routes:
      - name: feed-routes
        paths:
          - /api/v1/feeds
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 300
          hour: 3000

  - name: nutrition-service
    url: http://nutrition-service:8004
    routes:
      - name: nutrition-routes
        paths:
          - /api/v1/nutrition
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 50
          hour: 500

  - name: formulation-service
    url: http://formulation-service:8005
    routes:
      - name: formulation-routes
        paths:
          - /api/v1/formulation
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 30
          hour: 300
```

## 📋 API 엔드포인트 구조

### 기본 URL 구조
```
https://api.cnucnm.com/api/v1/{service}/{resource}
```

### 서비스별 API 경로
```
/api/v1/auth/*          # 인증 관련
/api/v1/users/*         # 사용자 관리
/api/v1/animals/*       # 동물 관리
/api/v1/feeds/*         # 사료 라이브러리
/api/v1/nutrition/*     # 영양 요구량
/api/v1/formulation/*   # 사료 배합
/api/v1/analysis/*      # 영양 분석
/api/v1/intake/*        # 섭취량 예측
/api/v1/reports/*       # 보고서 생성
/api/v1/notifications/* # 알림 관리
/api/v1/analytics/*     # 데이터 분석
```

## 🔐 인증 및 권한

### JWT 토큰 구조
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "email": "user@example.com",
    "role": "farmer",
    "permissions": ["read:animals", "write:animals"],
    "farm_id": "farm_uuid",
    "exp": 1640995200,
    "iat": 1640908800
  }
}
```

### 권한 레벨
```python
# 권한 정의
PERMISSIONS = {
    "farmer": [
        "read:own_animals",
        "write:own_animals",
        "read:own_farms",
        "write:own_farms",
        "read:feeds",
        "read:nutrition_calculations",
        "write:nutrition_calculations"
    ],
    "veterinarian": [
        "read:animals",
        "write:animals",
        "read:health_records",
        "write:health_records",
        "read:nutrition_reports"
    ],
    "admin": [
        "read:*",
        "write:*",
        "delete:*"
    ]
}
```

## 📊 API 응답 형식

### 표준 응답 구조
```json
{
  "success": true,
  "data": {
    // 실제 데이터
  },
  "meta": {
    "timestamp": "2024-01-01T00:00:00Z",
    "version": "1.0.0",
    "request_id": "req_123456"
  },
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 100,
    "total_pages": 5
  }
}
```

### 에러 응답 구조
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input data",
    "details": [
      {
        "field": "email",
        "message": "Invalid email format"
      }
    ]
  },
  "meta": {
    "timestamp": "2024-01-01T00:00:00Z",
    "version": "1.0.0",
    "request_id": "req_123456"
  }
}
```

## 🔧 OpenAPI 3.0 명세

### 기본 정보
```yaml
openapi: 3.0.3
info:
  title: CNUCNM API
  description: Chungnam National University Cattle Nutrition Model API
  version: 1.0.0
  contact:
    name: CNUCNM Team
    email: api@cnucnm.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.cnucnm.com/api/v1
    description: Production server
  - url: https://staging-api.cnucnm.com/api/v1
    description: Staging server
  - url: http://localhost:8000/api/v1
    description: Development server

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```

### 데이터 모델 정의
```yaml
components:
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        username:
          type: string
        role:
          type: string
          enum: [farmer, veterinarian, admin]
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
      required:
        - id
        - email
        - username
        - role

    Animal:
      type: object
      properties:
        id:
          type: string
          format: uuid
        farm_id:
          type: string
          format: uuid
        animal_id:
          type: string
        breed:
          type: string
          enum: [hanwoo, holstein, jersey]
        gender:
          type: string
          enum: [male, female]
        weight:
          type: number
          minimum: 0
        bcs:
          type: number
          minimum: 1
          maximum: 5
        stage:
          type: string
          enum: [calf, growing, lactating, drying]
      required:
        - farm_id
        - animal_id
        - breed
        - gender
        - weight

    Feed:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        name_korean:
          type: string
        feed_class:
          type: string
          enum: [forage, concentrate, byproduct]
        category:
          type: string
        description:
          type: string
      required:
        - name
        - feed_class

    NutritionRequirements:
      type: object
      properties:
        animal_id:
          type: string
          format: uuid
        maintenance_energy:
          type: number
        maintenance_protein:
          type: number
        growth_energy:
          type: number
        growth_protein:
          type: number
        lactation_energy:
          type: number
        lactation_protein:
          type: number
        total_energy:
          type: number
        total_protein:
          type: number
      required:
        - animal_id
        - total_energy
        - total_protein
```

### API 엔드포인트 정의

#### 사용자 관리 API
```yaml
paths:
  /auth/register:
    post:
      summary: 사용자 등록
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                username:
                  type: string
                password:
                  type: string
                  minLength: 8
                farm_name:
                  type: string
              required:
                - email
                - username
                - password
      responses:
        '201':
          description: 사용자 등록 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: 잘못된 입력 데이터
        '409':
          description: 이메일 중복

  /auth/login:
    post:
      summary: 사용자 로그인
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required:
                - email
                - password
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: 인증 실패

  /users/me:
    get:
      summary: 현재 사용자 정보 조회
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 사용자 정보 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: 인증 필요
```

#### 동물 관리 API
```yaml
  /animals:
    get:
      summary: 동물 목록 조회
      tags: [Animals]
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
        - name: breed
          in: query
          schema:
            type: string
        - name: stage
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 동물 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Animal'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      summary: 동물 등록
      tags: [Animals]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Animal'
      responses:
        '201':
          description: 동물 등록 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Animal'

  /animals/{animal_id}:
    get:
      summary: 동물 상세 정보 조회
      tags: [Animals]
      security:
        - BearerAuth: []
      parameters:
        - name: animal_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 동물 정보 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Animal'
        '404':
          description: 동물을 찾을 수 없음

    put:
      summary: 동물 정보 수정
      tags: [Animals]
      security:
        - BearerAuth: []
      parameters:
        - name: animal_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Animal'
      responses:
        '200':
          description: 동물 정보 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Animal'
```

#### 영양 계산 API
```yaml
  /nutrition/calculate-requirements:
    post:
      summary: 영양 요구량 계산
      tags: [Nutrition]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                animal_id:
                  type: string
                  format: uuid
                breed:
                  type: string
                stage:
                  type: string
                weight:
                  type: number
                milk_yield:
                  type: number
                target_adg:
                  type: number
              required:
                - animal_id
                - breed
                - stage
                - weight
      responses:
        '200':
          description: 영양 요구량 계산 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NutritionRequirements'
        '400':
          description: 잘못된 입력 데이터
        '404':
          description: 동물을 찾을 수 없음

  /formulation/optimize:
    post:
      summary: 사료 배합 최적화
      tags: [Formulation]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                animal_id:
                  type: string
                  format: uuid
                target_dmi:
                  type: number
                available_feeds:
                  type: array
                  items:
                    type: string
                    format: uuid
                nutrient_constraints:
                  type: object
              required:
                - animal_id
                - target_dmi
                - available_feeds
      responses:
        '200':
          description: 배합 최적화 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  feed_mixture:
                    type: object
                  total_cost:
                    type: number
                  nutrient_composition:
                    type: object
        '400':
          description: 최적화 실패
```

## 📈 API 성능 및 모니터링

### 성능 지표
```yaml
# API 성능 목표
performance_targets:
  response_time:
    p50: < 200ms
    p95: < 500ms
    p99: < 1000ms
  availability: > 99.9%
  error_rate: < 0.1%
  throughput: > 1000 req/sec
```

### 모니터링 메트릭
```python
# Prometheus 메트릭
from prometheus_client import Counter, Histogram, Gauge

# API 호출 통계
api_requests_total = Counter(
    'api_requests_total',
    'Total API requests',
    ['method', 'endpoint', 'status']
)

# 응답 시간
api_request_duration = Histogram(
    'api_request_duration_seconds',
    'API request duration',
    ['method', 'endpoint']
)

# 활성 사용자 수
active_users = Gauge(
    'active_users_total',
    'Total active users'
)

# 에러율
api_error_rate = Gauge(
    'api_error_rate',
    'API error rate'
)
```

## 🔄 API 버전 관리

### 버전 관리 전략
```yaml
# API 버전 관리
versioning:
  strategy: "URL Path"
  current_version: "v1"
  supported_versions: ["v1"]
  deprecation_policy:
    notice_period: "6 months"
    sunset_period: "12 months"
```

### 버전별 호환성
```python
# API 버전 호환성 체크
def check_api_compatibility(client_version: str, server_version: str) -> bool:
    """
    클라이언트와 서버 API 버전 호환성 검사
    """
    client_major = int(client_version.split('.')[0][1:])  # v1 -> 1
    server_major = int(server_version.split('.')[0][1:])
    
    # 메이저 버전이 같으면 호환
    return client_major == server_major
```

## 🧪 API 테스트

### 테스트 전략
```python
# API 테스트 예시
import pytest
import httpx

@pytest.mark.asyncio
async def test_user_registration():
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://localhost:8000/api/v1/auth/register",
            json={
                "email": "test@example.com",
                "username": "testuser",
                "password": "password123",
                "farm_name": "Test Farm"
            }
        )
        
        assert response.status_code == 201
        data = response.json()
        assert data["success"] is True
        assert "id" in data["data"]

@pytest.mark.asyncio
async def test_nutrition_calculation():
    async with httpx.AsyncClient() as client:
        # 먼저 로그인
        login_response = await client.post(
            "http://localhost:8000/api/v1/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
        
        token = login_response.json()["access_token"]
        
        # 영양 계산 요청
        response = await client.post(
            "http://localhost:8000/api/v1/nutrition/calculate-requirements",
            headers={"Authorization": f"Bearer {token}"},
            json={
                "animal_id": "animal-uuid",
                "breed": "hanwoo",
                "stage": "lactating",
                "weight": 600.0,
                "milk_yield": 25.0
            }
        )
        
        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert "total_energy" in data["data"]
```

## 📚 API 문서화

### Swagger UI 설정
```python
# FastAPI Swagger 설정
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

app = FastAPI(
    title="CNUCNM API",
    description="Chungnam National University Cattle Nutrition Model API",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema
    
    openapi_schema = get_openapi(
        title="CNUCNM API",
        version="1.0.0",
        description="Comprehensive cattle nutrition management API",
        routes=app.routes,
    )
    
    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi
```

---

*이 문서는 CNUCNM API의 전체적인 전략과 명세를 정의하며, 개발팀과 클라이언트 개발자들이 참고할 수 있는 완전한 API 가이드를 제공합니다.*
