# 5. CNUCNM API ì „ëµ ë° ëª…ì„¸

## ğŸ¯ API ì „ëµ ê°œìš”

### API First ì ‘ê·¼ë²•
- **ëª¨ë“  ê¸°ëŠ¥ì„ APIë¡œ ë…¸ì¶œ**: ì›¹, ëª¨ë°”ì¼, ì„œë“œíŒŒí‹° í†µí•©
- **RESTful ì„¤ê³„**: í‘œì¤€ HTTP ë©”ì„œë“œì™€ ìƒíƒœ ì½”ë“œ
- **OpenAPI 3.0 ëª…ì„¸**: ìë™ ë¬¸ì„œí™” ë° ì½”ë“œ ìƒì„±
- **ë²„ì „ ê´€ë¦¬**: API ë²„ì „ë³„ í˜¸í™˜ì„± ë³´ì¥

### API ê²Œì´íŠ¸ì›¨ì´ ì—­í• 
- **ë‹¨ì¼ ì§„ì…ì **: ëª¨ë“  API ìš”ì²­ì˜ ì¤‘ì•™ ì§‘ì¤‘í™”
- **ì¸ì¦ ë° ê¶Œí•œ**: JWT í† í° ê²€ì¦ ë° RBAC
- **ë¡œë“œ ë°¸ëŸ°ì‹±**: íŠ¸ë˜í”½ ë¶„ì‚° ë° ì¥ì•  ë³µêµ¬
- **ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…**: API ì‚¬ìš©ëŸ‰ ì œí•œ
- **ëª¨ë‹ˆí„°ë§**: API í˜¸ì¶œ í†µê³„ ë° ì„±ëŠ¥ ì¸¡ì •

## ğŸ—ï¸ API ê²Œì´íŠ¸ì›¨ì´ ì•„í‚¤í…ì²˜

### Kong API Gateway ì„¤ì •

```yaml
# kong.yml
_format_version: "2.1"
_transform: true

services:
  - name: user-service
    url: http://user-service:8001
    routes:
      - name: user-routes
        paths:
          - /api/v1/users
          - /api/v1/auth
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000

  - name: animal-service
    url: http://animal-service:8002
    routes:
      - name: animal-routes
        paths:
          - /api/v1/animals
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000

  - name: feed-library-service
    url: http://feed-library-service:8003
    routes:
      - name: feed-routes
        paths:
          - /api/v1/feeds
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 300
          hour: 3000

  - name: nutrition-service
    url: http://nutrition-service:8004
    routes:
      - name: nutrition-routes
        paths:
          - /api/v1/nutrition
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 50
          hour: 500

  - name: formulation-service
    url: http://formulation-service:8005
    routes:
      - name: formulation-routes
        paths:
          - /api/v1/formulation
        strip_path: true
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 30
          hour: 300
```

## ğŸ“‹ API ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡°

### ê¸°ë³¸ URL êµ¬ì¡°
```
https://api.cnucnm.com/api/v1/{service}/{resource}
```

### ì„œë¹„ìŠ¤ë³„ API ê²½ë¡œ
```
/api/v1/auth/*          # ì¸ì¦ ê´€ë ¨
/api/v1/users/*         # ì‚¬ìš©ì ê´€ë¦¬
/api/v1/animals/*       # ë™ë¬¼ ê´€ë¦¬
/api/v1/feeds/*         # ì‚¬ë£Œ ë¼ì´ë¸ŒëŸ¬ë¦¬
/api/v1/nutrition/*     # ì˜ì–‘ ìš”êµ¬ëŸ‰
/api/v1/formulation/*   # ì‚¬ë£Œ ë°°í•©
/api/v1/analysis/*      # ì˜ì–‘ ë¶„ì„
/api/v1/intake/*        # ì„­ì·¨ëŸ‰ ì˜ˆì¸¡
/api/v1/reports/*       # ë³´ê³ ì„œ ìƒì„±
/api/v1/notifications/* # ì•Œë¦¼ ê´€ë¦¬
/api/v1/analytics/*     # ë°ì´í„° ë¶„ì„
```

## ğŸ” ì¸ì¦ ë° ê¶Œí•œ

### JWT í† í° êµ¬ì¡°
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "email": "user@example.com",
    "role": "farmer",
    "permissions": ["read:animals", "write:animals"],
    "farm_id": "farm_uuid",
    "exp": 1640995200,
    "iat": 1640908800
  }
}
```

### ê¶Œí•œ ë ˆë²¨
```python
# ê¶Œí•œ ì •ì˜
PERMISSIONS = {
    "farmer": [
        "read:own_animals",
        "write:own_animals",
        "read:own_farms",
        "write:own_farms",
        "read:feeds",
        "read:nutrition_calculations",
        "write:nutrition_calculations"
    ],
    "veterinarian": [
        "read:animals",
        "write:animals",
        "read:health_records",
        "write:health_records",
        "read:nutrition_reports"
    ],
    "admin": [
        "read:*",
        "write:*",
        "delete:*"
    ]
}
```

## ğŸ“Š API ì‘ë‹µ í˜•ì‹

### í‘œì¤€ ì‘ë‹µ êµ¬ì¡°
```json
{
  "success": true,
  "data": {
    // ì‹¤ì œ ë°ì´í„°
  },
  "meta": {
    "timestamp": "2024-01-01T00:00:00Z",
    "version": "1.0.0",
    "request_id": "req_123456"
  },
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 100,
    "total_pages": 5
  }
}
```

### ì—ëŸ¬ ì‘ë‹µ êµ¬ì¡°
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input data",
    "details": [
      {
        "field": "email",
        "message": "Invalid email format"
      }
    ]
  },
  "meta": {
    "timestamp": "2024-01-01T00:00:00Z",
    "version": "1.0.0",
    "request_id": "req_123456"
  }
}
```

## ğŸ”§ OpenAPI 3.0 ëª…ì„¸

### ê¸°ë³¸ ì •ë³´
```yaml
openapi: 3.0.3
info:
  title: CNUCNM API
  description: Chungnam National University Cattle Nutrition Model API
  version: 1.0.0
  contact:
    name: CNUCNM Team
    email: api@cnucnm.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.cnucnm.com/api/v1
    description: Production server
  - url: https://staging-api.cnucnm.com/api/v1
    description: Staging server
  - url: http://localhost:8000/api/v1
    description: Development server

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```

### ë°ì´í„° ëª¨ë¸ ì •ì˜
```yaml
components:
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        username:
          type: string
        role:
          type: string
          enum: [farmer, veterinarian, admin]
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
      required:
        - id
        - email
        - username
        - role

    Animal:
      type: object
      properties:
        id:
          type: string
          format: uuid
        farm_id:
          type: string
          format: uuid
        animal_id:
          type: string
        breed:
          type: string
          enum: [hanwoo, holstein, jersey]
        gender:
          type: string
          enum: [male, female]
        weight:
          type: number
          minimum: 0
        bcs:
          type: number
          minimum: 1
          maximum: 5
        stage:
          type: string
          enum: [calf, growing, lactating, drying]
      required:
        - farm_id
        - animal_id
        - breed
        - gender
        - weight

    Feed:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        name_korean:
          type: string
        feed_class:
          type: string
          enum: [forage, concentrate, byproduct]
        category:
          type: string
        description:
          type: string
      required:
        - name
        - feed_class

    NutritionRequirements:
      type: object
      properties:
        animal_id:
          type: string
          format: uuid
        maintenance_energy:
          type: number
        maintenance_protein:
          type: number
        growth_energy:
          type: number
        growth_protein:
          type: number
        lactation_energy:
          type: number
        lactation_protein:
          type: number
        total_energy:
          type: number
        total_protein:
          type: number
      required:
        - animal_id
        - total_energy
        - total_protein
```

### API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜

#### ì‚¬ìš©ì ê´€ë¦¬ API
```yaml
paths:
  /auth/register:
    post:
      summary: ì‚¬ìš©ì ë“±ë¡
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                username:
                  type: string
                password:
                  type: string
                  minLength: 8
                farm_name:
                  type: string
              required:
                - email
                - username
                - password
      responses:
        '201':
          description: ì‚¬ìš©ì ë“±ë¡ ì„±ê³µ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: ì˜ëª»ëœ ì…ë ¥ ë°ì´í„°
        '409':
          description: ì´ë©”ì¼ ì¤‘ë³µ

  /auth/login:
    post:
      summary: ì‚¬ìš©ì ë¡œê·¸ì¸
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required:
                - email
                - password
      responses:
        '200':
          description: ë¡œê·¸ì¸ ì„±ê³µ
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: ì¸ì¦ ì‹¤íŒ¨

  /users/me:
    get:
      summary: í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: ì¸ì¦ í•„ìš”
```

#### ë™ë¬¼ ê´€ë¦¬ API
```yaml
  /animals:
    get:
      summary: ë™ë¬¼ ëª©ë¡ ì¡°íšŒ
      tags: [Animals]
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
        - name: breed
          in: query
          schema:
            type: string
        - name: stage
          in: query
          schema:
            type: string
      responses:
        '200':
          description: ë™ë¬¼ ëª©ë¡ ì¡°íšŒ ì„±ê³µ
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Animal'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      summary: ë™ë¬¼ ë“±ë¡
      tags: [Animals]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Animal'
      responses:
        '201':
          description: ë™ë¬¼ ë“±ë¡ ì„±ê³µ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Animal'

  /animals/{animal_id}:
    get:
      summary: ë™ë¬¼ ìƒì„¸ ì •ë³´ ì¡°íšŒ
      tags: [Animals]
      security:
        - BearerAuth: []
      parameters:
        - name: animal_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: ë™ë¬¼ ì •ë³´ ì¡°íšŒ ì„±ê³µ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Animal'
        '404':
          description: ë™ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ

    put:
      summary: ë™ë¬¼ ì •ë³´ ìˆ˜ì •
      tags: [Animals]
      security:
        - BearerAuth: []
      parameters:
        - name: animal_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Animal'
      responses:
        '200':
          description: ë™ë¬¼ ì •ë³´ ìˆ˜ì • ì„±ê³µ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Animal'
```

#### ì˜ì–‘ ê³„ì‚° API
```yaml
  /nutrition/calculate-requirements:
    post:
      summary: ì˜ì–‘ ìš”êµ¬ëŸ‰ ê³„ì‚°
      tags: [Nutrition]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                animal_id:
                  type: string
                  format: uuid
                breed:
                  type: string
                stage:
                  type: string
                weight:
                  type: number
                milk_yield:
                  type: number
                target_adg:
                  type: number
              required:
                - animal_id
                - breed
                - stage
                - weight
      responses:
        '200':
          description: ì˜ì–‘ ìš”êµ¬ëŸ‰ ê³„ì‚° ì„±ê³µ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NutritionRequirements'
        '400':
          description: ì˜ëª»ëœ ì…ë ¥ ë°ì´í„°
        '404':
          description: ë™ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ

  /formulation/optimize:
    post:
      summary: ì‚¬ë£Œ ë°°í•© ìµœì í™”
      tags: [Formulation]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                animal_id:
                  type: string
                  format: uuid
                target_dmi:
                  type: number
                available_feeds:
                  type: array
                  items:
                    type: string
                    format: uuid
                nutrient_constraints:
                  type: object
              required:
                - animal_id
                - target_dmi
                - available_feeds
      responses:
        '200':
          description: ë°°í•© ìµœì í™” ì„±ê³µ
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  feed_mixture:
                    type: object
                  total_cost:
                    type: number
                  nutrient_composition:
                    type: object
        '400':
          description: ìµœì í™” ì‹¤íŒ¨
```

## ğŸ“ˆ API ì„±ëŠ¥ ë° ëª¨ë‹ˆí„°ë§

### ì„±ëŠ¥ ì§€í‘œ
```yaml
# API ì„±ëŠ¥ ëª©í‘œ
performance_targets:
  response_time:
    p50: < 200ms
    p95: < 500ms
    p99: < 1000ms
  availability: > 99.9%
  error_rate: < 0.1%
  throughput: > 1000 req/sec
```

### ëª¨ë‹ˆí„°ë§ ë©”íŠ¸ë¦­
```python
# Prometheus ë©”íŠ¸ë¦­
from prometheus_client import Counter, Histogram, Gauge

# API í˜¸ì¶œ í†µê³„
api_requests_total = Counter(
    'api_requests_total',
    'Total API requests',
    ['method', 'endpoint', 'status']
)

# ì‘ë‹µ ì‹œê°„
api_request_duration = Histogram(
    'api_request_duration_seconds',
    'API request duration',
    ['method', 'endpoint']
)

# í™œì„± ì‚¬ìš©ì ìˆ˜
active_users = Gauge(
    'active_users_total',
    'Total active users'
)

# ì—ëŸ¬ìœ¨
api_error_rate = Gauge(
    'api_error_rate',
    'API error rate'
)
```

## ğŸ”„ API ë²„ì „ ê´€ë¦¬

### ë²„ì „ ê´€ë¦¬ ì „ëµ
```yaml
# API ë²„ì „ ê´€ë¦¬
versioning:
  strategy: "URL Path"
  current_version: "v1"
  supported_versions: ["v1"]
  deprecation_policy:
    notice_period: "6 months"
    sunset_period: "12 months"
```

### ë²„ì „ë³„ í˜¸í™˜ì„±
```python
# API ë²„ì „ í˜¸í™˜ì„± ì²´í¬
def check_api_compatibility(client_version: str, server_version: str) -> bool:
    """
    í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ API ë²„ì „ í˜¸í™˜ì„± ê²€ì‚¬
    """
    client_major = int(client_version.split('.')[0][1:])  # v1 -> 1
    server_major = int(server_version.split('.')[0][1:])
    
    # ë©”ì´ì € ë²„ì „ì´ ê°™ìœ¼ë©´ í˜¸í™˜
    return client_major == server_major
```

## ğŸ§ª API í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ì „ëµ
```python
# API í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
import pytest
import httpx

@pytest.mark.asyncio
async def test_user_registration():
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "http://localhost:8000/api/v1/auth/register",
            json={
                "email": "test@example.com",
                "username": "testuser",
                "password": "password123",
                "farm_name": "Test Farm"
            }
        )
        
        assert response.status_code == 201
        data = response.json()
        assert data["success"] is True
        assert "id" in data["data"]

@pytest.mark.asyncio
async def test_nutrition_calculation():
    async with httpx.AsyncClient() as client:
        # ë¨¼ì € ë¡œê·¸ì¸
        login_response = await client.post(
            "http://localhost:8000/api/v1/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
        
        token = login_response.json()["access_token"]
        
        # ì˜ì–‘ ê³„ì‚° ìš”ì²­
        response = await client.post(
            "http://localhost:8000/api/v1/nutrition/calculate-requirements",
            headers={"Authorization": f"Bearer {token}"},
            json={
                "animal_id": "animal-uuid",
                "breed": "hanwoo",
                "stage": "lactating",
                "weight": 600.0,
                "milk_yield": 25.0
            }
        )
        
        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert "total_energy" in data["data"]
```

## ğŸ“š API ë¬¸ì„œí™”

### Swagger UI ì„¤ì •
```python
# FastAPI Swagger ì„¤ì •
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

app = FastAPI(
    title="CNUCNM API",
    description="Chungnam National University Cattle Nutrition Model API",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema
    
    openapi_schema = get_openapi(
        title="CNUCNM API",
        version="1.0.0",
        description="Comprehensive cattle nutrition management API",
        routes=app.routes,
    )
    
    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi
```

---

*ì´ ë¬¸ì„œëŠ” CNUCNM APIì˜ ì „ì²´ì ì¸ ì „ëµê³¼ ëª…ì„¸ë¥¼ ì •ì˜í•˜ë©°, ê°œë°œíŒ€ê³¼ í´ë¼ì´ì–¸íŠ¸ ê°œë°œìë“¤ì´ ì°¸ê³ í•  ìˆ˜ ìˆëŠ” ì™„ì „í•œ API ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.*
